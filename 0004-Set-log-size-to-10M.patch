From ada033b9c7976d506a4332b0c759e54b15b0ef3a Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 18 Jan 2024 00:03:07 +0100
Subject: [PATCH 4/5] Set log size to 10M

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 services/journald@sched-ext.conf | 7 +++++++
 services/meson.build             | 8 ++++++++
 services/scx_central.service     | 4 +++-
 services/scx_flatcg.service      | 4 +++-
 services/scx_nest.service        | 4 +++-
 services/scx_pair.service        | 4 +++-
 services/scx_qmap.service        | 4 +++-
 services/scx_rustland.service    | 4 +++-
 services/scx_rusty.service       | 4 +++-
 services/scx_simple.service      | 4 +++-
 services/scx_userland.service    | 4 +++-
 11 files changed, 42 insertions(+), 9 deletions(-)
 create mode 100644 services/journald@sched-ext.conf

diff --git a/services/journald@sched-ext.conf b/services/journald@sched-ext.conf
new file mode 100644
index 0000000..6e68c17
--- /dev/null
+++ b/services/journald@sched-ext.conf
@@ -0,0 +1,7 @@
+[Journal]
+# Sets the maximum journal size to 10M for each namespace.
+NamespaceMaxUse=10M
+# Sets the maximum log age to 7 days.
+MaxRetentionSec=7day
+# Sets the priority level for messages to be stored to info.
+MaxLevelStore=info
diff --git a/services/meson.build b/services/meson.build
index a323d9e..de640dc 100644
--- a/services/meson.build
+++ b/services/meson.build
@@ -6,3 +6,11 @@ systemd_system_unit_dir = systemd.get_variable(pkgconfig : 'systemdsystemunitdir
     ],
     install_dir: systemd_system_unit_dir
   )
+
+  install_data(
+    [
+      'journald@sched-ext.conf',
+    ],
+    install_dir: '/etc/systemd/journald@sched-ext.conf.d'
+  )
+
diff --git a/services/scx_central.service b/services/scx_central.service
index 536bb3b..e7c541b 100644
--- a/services/scx_central.service
+++ b/services/scx_central.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_central
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_flatcg.service b/services/scx_flatcg.service
index e7a2e64..bad558a 100644
--- a/services/scx_flatcg.service
+++ b/services/scx_flatcg.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_flatcg
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_nest.service b/services/scx_nest.service
index 7bacf12..89ed126 100644
--- a/services/scx_nest.service
+++ b/services/scx_nest.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_nest
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_pair.service b/services/scx_pair.service
index 61e72ce..6bc3b1c 100644
--- a/services/scx_pair.service
+++ b/services/scx_pair.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_pair
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_qmap.service b/services/scx_qmap.service
index 5efc2f5..a2bab8f 100644
--- a/services/scx_qmap.service
+++ b/services/scx_qmap.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_qmap
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_rustland.service b/services/scx_rustland.service
index 57b89f2..e54b327 100644
--- a/services/scx_rustland.service
+++ b/services/scx_rustland.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_rustland
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_rusty.service b/services/scx_rusty.service
index a42ced3..0405c8e 100644
--- a/services/scx_rusty.service
+++ b/services/scx_rusty.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_rusty
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_simple.service b/services/scx_simple.service
index c5169d7..d1a2ac1 100644
--- a/services/scx_simple.service
+++ b/services/scx_simple.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_simple
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
diff --git a/services/scx_userland.service b/services/scx_userland.service
index f4d8ca8..a7cbc07 100644
--- a/services/scx_userland.service
+++ b/services/scx_userland.service
@@ -6,7 +6,9 @@ ConditionPathExists=/sys/kernel/debug/sched/ext
 Type=simple
 ExecStart=scx_userland
 Restart=always
-StandardOutput=null
+StandardOutput=journal
+StandardError=journal
+LogNamespace=sched-ext
 
 [Install]
 WantedBy=multi-user.target
-- 
2.43.0.232.ge79552d197

