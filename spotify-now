#!/usr/bin/env bash
#
# https://github.com/getmicah/spotify-now


getAlbum () {
    album=$(echo "$MSG" | grep -m 1 "xesam:album" -b1 | tail -n1 | cut -d'"' -f2)
    echo "$album"
}
getArtist () {
    artist=$(echo "$MSG" | grep -m 1 "xesam:albumArtist" -b2 | tail -n1 | cut -d'"' -f2)
    echo "$artist"
}
getTitle () {
    title=$(echo "$MSG" | grep -m 1 "xesam:title" -b1 | tail -n1 | cut -d'"' -f2)
    echo "$title"
}



# globals
MSG=""
RES=""

# check if no args
if [[ $# -eq 0 ]];
then
    echo "Hello, this is spotify-now:"
    echo "https://github.com/getmicah/spotify-now"
    exit 0
fi

# check if spotify is running
if test `pidof spotify | wc -l` != 1
then
    # custom stop status
    if test "${1}" == "-m"
    then
        echo "${2}"
    else
        echo "Spotify doesn't seem to be running."
    fi
    exit 0
else
    # get mpris2 dbus status of spotify player
    MSG=`dbus-send --print-reply --session --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'Metadata'`
fi

# print each arg with info
start=1
end=$#
if test "${1}" == "-m"
then
    start=3
fi
for i in `seq $start $end`;
do
    case "${!i}" in
       %album) RES="$RES $(getAlbum)"
       ;;
       %artist) RES="$RES $(getArtist)"
       ;;
       %title) RES="$RES $(getTitle)"
       ;;
       *) RES="$RES ${!i}"
       ;;
    esac
done


# LIFTOFF
echo $RES
