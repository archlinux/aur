From d618a06d92e69850b42c271f04ba90c2464c7783 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Mon, 15 Jan 2024 23:41:59 +0100
Subject: [PATCH] Add systemd services for scx schedulers

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 meson.build                         |  6 ++++++
 meson.options                       |  6 ++++++
 services/meson.build                |  8 ++++++++
 services/sched-ext-central.service  | 12 ++++++++++++
 services/sched-ext-flatcg.service   | 12 ++++++++++++
 services/sched-ext-nest.service     | 12 ++++++++++++
 services/sched-ext-pair.service     | 12 ++++++++++++
 services/sched-ext-qmap.service     | 12 ++++++++++++
 services/sched-ext-rustland.service | 12 ++++++++++++
 services/sched-ext-rusty.service    | 12 ++++++++++++
 services/sched-ext-simple.service   | 12 ++++++++++++
 services/sched-ext-userland.service | 12 ++++++++++++
 12 files changed, 128 insertions(+)
 create mode 100644 services/meson.build
 create mode 100644 services/sched-ext-central.service
 create mode 100644 services/sched-ext-flatcg.service
 create mode 100644 services/sched-ext-nest.service
 create mode 100644 services/sched-ext-pair.service
 create mode 100644 services/sched-ext-qmap.service
 create mode 100644 services/sched-ext-rustland.service
 create mode 100644 services/sched-ext-rusty.service
 create mode 100644 services/sched-ext-simple.service
 create mode 100644 services/sched-ext-userland.service

diff --git a/meson.build b/meson.build
index 1b105e2..5842311 100644
--- a/meson.build
+++ b/meson.build
@@ -158,3 +158,9 @@ if get_option('enable_rust')
   subdir('rust')
 endif
 subdir('scheds')
+
+systemd = dependency('systemd', required: get_option('systemd'))
+
+if systemd.found()
+  subdir('services')
+endif
diff --git a/meson.options b/meson.options
index a8752df..6cd9260 100644
--- a/meson.options
+++ b/meson.options
@@ -16,3 +16,9 @@ option('enable_rust', type: 'boolean', value: 'true',
        description: 'Enable rust sub-projects')
 option('kernel', type: 'string', value: 'vmlinuz',
        description: 'kernel image used to test schedulers')
+option(
+  'systemd',
+  type: 'feature',
+  value: 'auto',
+  description: 'sd-notify support via libsystemd and install systemd unit files'
+)
diff --git a/services/meson.build b/services/meson.build
new file mode 100644
index 0000000..7c27e3a
--- /dev/null
+++ b/services/meson.build
@@ -0,0 +1,8 @@
+systemd_system_unit_dir = systemd.get_variable(pkgconfig : 'systemdsystemunitdir')
+
+  install_data(
+    [
+      'sched-ext-central.service',  'sched-ext-flatcg.service',  'sched-ext-nest.service',  'sched-ext-pair.service', 'sched-ext-qmap.service', 'sched-ext-rustland.service',  'sched-ext-rusty.service',  'sched-ext-simple.service',  'sched-ext-userland.service',
+    ],
+    install_dir: systemd_system_unit_dir
+  )
diff --git a/services/sched-ext-central.service b/services/sched-ext-central.service
new file mode 100644
index 0000000..15eb7dc
--- /dev/null
+++ b/services/sched-ext-central.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_central
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_central
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-flatcg.service b/services/sched-ext-flatcg.service
new file mode 100644
index 0000000..31a1d15
--- /dev/null
+++ b/services/sched-ext-flatcg.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_flatcg
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_flatcg
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-nest.service b/services/sched-ext-nest.service
new file mode 100644
index 0000000..e3b5e4c
--- /dev/null
+++ b/services/sched-ext-nest.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_nest
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_nest
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-pair.service b/services/sched-ext-pair.service
new file mode 100644
index 0000000..ef8b691
--- /dev/null
+++ b/services/sched-ext-pair.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_pair
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_pair
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-qmap.service b/services/sched-ext-qmap.service
new file mode 100644
index 0000000..fba833c
--- /dev/null
+++ b/services/sched-ext-qmap.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_qmap
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_qmap
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-rustland.service b/services/sched-ext-rustland.service
new file mode 100644
index 0000000..86e131e
--- /dev/null
+++ b/services/sched-ext-rustland.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_rustland
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_rustland
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-rusty.service b/services/sched-ext-rusty.service
new file mode 100644
index 0000000..56ba2da
--- /dev/null
+++ b/services/sched-ext-rusty.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_rusty
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_rusty
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-simple.service b/services/sched-ext-simple.service
new file mode 100644
index 0000000..3908e9d
--- /dev/null
+++ b/services/sched-ext-simple.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_simple
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_simple
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/sched-ext-userland.service b/services/sched-ext-userland.service
new file mode 100644
index 0000000..51f47ae
--- /dev/null
+++ b/services/sched-ext-userland.service
@@ -0,0 +1,12 @@
+[Unit]
+Description=Start scx_userland
+ConditionPathExists=/sys/kernel/debug/sched/ext
+
+[Service]
+Type=simple
+ExecStart=/usr/bin/scx_userland
+Restart=always
+StandardOutput=null
+
+[Install]
+WantedBy=multi-user.target
-- 
2.43.0.232.ge79552d197

