From 2a7b7c6faafc5fb846776145cc19cd05dfd65723 Mon Sep 17 00:00:00 2001
From: Ewout van Mansom <ewout@vanmansom.name>
Date: Tue, 2 May 2023 14:19:36 +0200
Subject: [PATCH 1/2] Support system-wide setting schema

---
 prefs.js | 21 +++++++++++++++------
 1 file changed, 15 insertions(+), 6 deletions(-)

diff --git a/prefs.js b/prefs.js
index cdcd50e..0eed75a 100644
--- a/prefs.js
+++ b/prefs.js
@@ -17,15 +17,24 @@ var Prefs = class Prefs {
         this.KEY_HIBERNATE_WORKS_CHECK = "hibernate-works-check";
         this._schemaName = "org.gnome.shell.extensions.hibernate-status-button";
 
-        let schemaDir = Me.dir.get_child('schemas').get_path();
+        // first try developer local schema
+        try {
+            let schemaDir = Me.dir.get_child('schemas').get_path();
 
-        let schemaSource = Gio.SettingsSchemaSource.new_from_directory(
-            schemaDir, Gio.SettingsSchemaSource.get_default(), false
-        );
-        let schema = schemaSource.lookup(this._schemaName, false);
+            let schemaSource = Gio.SettingsSchemaSource.new_from_directory(
+                schemaDir, Gio.SettingsSchemaSource.get_default(), false
+            );
+            let schema = schemaSource.lookup(this._schemaName, false);
+
+            this._setting = new Gio.Settings({
+                settings_schema: schema
+            });
+        } catch (e) {
+            // now try system-wide one below
+        }
 
         this._setting = new Gio.Settings({
-            settings_schema: schema
+            schema_id: this._schemaName
         });
     }
     /**

From 003198046f6264cf2845e1b9cfd195e71c2f2674 Mon Sep 17 00:00:00 2001
From: Ewout van Mansom <ewout@vanmansom.name>
Date: Tue, 2 May 2023 14:20:12 +0200
Subject: [PATCH 2/2] Don't ship developer oriented schema in system-wide
 installation

---
 Makefile | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index 3378024..80f5796 100644
--- a/Makefile
+++ b/Makefile
@@ -52,8 +52,7 @@ install-local: _build
 	cp -r ./_build/* $(INSTALLBASE)/$(INSTALLNAME)/
 ifeq ($(INSTALLTYPE),system)
 	# system-wide settings and locale files
-	# rm -r $(INSTALLBASE)/$(INSTALLNAME)/schemas
-	rm -f $(INSTALLBASE)/$(INSTALLNAME)/schemas/*gschema.xml
+	rm -r $(INSTALLBASE)/$(INSTALLNAME)/schemas
 	rm -r $(INSTALLBASE)/$(INSTALLNAME)/locale
 	mkdir -p $(SHARE_PREFIX)/glib-2.0/schemas $(SHARE_PREFIX)/locale
 	cp -r ./schemas/*gschema.* $(SHARE_PREFIX)/glib-2.0/schemas
