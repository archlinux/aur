From 9059742323460bf69729c7b2387228f7e025dced Mon Sep 17 00:00:00 2001
From: Felix Ernst <fe.a.ernst@gmail.com>
Date: Wed, 14 Dec 2022 14:30:50 +0100
Subject: [PATCH 1/3] Revert "Fix build with older KF versions"

This reverts commit 1d04d04cf301e82971d90cceb541f368192e2167.
---
 src/trash/dolphintrash.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/trash/dolphintrash.cpp b/src/trash/dolphintrash.cpp
index 906da2b9d..236f9817d 100644
--- a/src/trash/dolphintrash.cpp
+++ b/src/trash/dolphintrash.cpp
@@ -75,7 +75,7 @@ void Trash::empty(QWidget *window)
         KIO::Job* job = KIO::emptyTrash();
         KJobWidgets::setWindow(job, window);
         job->uiDelegate()->setAutoErrorHandlingEnabled(true);
-        QObject::connect(job, &KIO::Job::result, notifyEmptied);
+        QObject::connect(emptyJob, &KIO::Job::result, notifyEmptied);
     }
 #endif
 }
-- 
GitLab


From f0a6120eb95f44eb97bb801869b5b19812e6d517 Mon Sep 17 00:00:00 2001
From: Felix Ernst <fe.a.ernst@gmail.com>
Date: Wed, 14 Dec 2022 14:31:18 +0100
Subject: [PATCH 2/3] Revert "Port away from deprecated KIO API"

This reverts commit 197a7f690571256c8007b78a8fea30edb176a978.
---
 src/panels/folders/treeviewcontextmenu.cpp | 22 ++--------------------
 src/views/dolphinview.cpp                  | 20 --------------------
 2 files changed, 2 insertions(+), 40 deletions(-)

diff --git a/src/panels/folders/treeviewcontextmenu.cpp b/src/panels/folders/treeviewcontextmenu.cpp
index e0da9e976..f4181d064 100644
--- a/src/panels/folders/treeviewcontextmenu.cpp
+++ b/src/panels/folders/treeviewcontextmenu.cpp
@@ -14,6 +14,8 @@
 #include <KFileItemListProperties>
 #include <KIO/CopyJob>
 #include <KIO/DeleteJob>
+#include <KIO/FileUndoManager>
+#include <KIO/JobUiDelegate>
 #include <KIO/Paste>
 #include <KIO/PasteJob>
 #include <KJobWidgets>
@@ -22,14 +24,6 @@
 #include <KSharedConfig>
 #include <KUrlMimeData>
 
-#include <kio_version.h>
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-#include <KIO/DeleteOrTrashJob>
-#else
-#include <KIO/FileUndoManager>
-#include <KIO/JobUiDelegate>
-#endif
-
 #include <QApplication>
 #include <QClipboard>
 #include <QMenu>
@@ -198,11 +192,6 @@ void TreeViewContextMenu::rename()
 
 void TreeViewContextMenu::moveToTrash()
 {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-    using Iface = KIO::AskUserActionInterface;
-    auto *deleteJob = new KIO::DeleteOrTrashJob(QList{m_fileItem.url()}, Iface::Trash, Iface::DefaultConfirmation, m_parent);
-    deleteJob->start();
-#else
     const QList<QUrl> list{m_fileItem.url()};
     KIO::JobUiDelegate uiDelegate;
     uiDelegate.setWindow(m_parent);
@@ -212,16 +201,10 @@ void TreeViewContextMenu::moveToTrash()
         KJobWidgets::setWindow(job, m_parent);
         job->uiDelegate()->setAutoErrorHandlingEnabled(true);
     }
-#endif
 }
 
 void TreeViewContextMenu::deleteItem()
 {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-    using Iface = KIO::AskUserActionInterface;
-    auto *deleteJob = new KIO::DeleteOrTrashJob(QList{m_fileItem.url()}, Iface::Delete, Iface::DefaultConfirmation, m_parent);
-    deleteJob->start();
-#else
     const QList<QUrl> list{m_fileItem.url()};
     KIO::JobUiDelegate uiDelegate;
     uiDelegate.setWindow(m_parent);
@@ -230,7 +213,6 @@ void TreeViewContextMenu::deleteItem()
         KJobWidgets::setWindow(job, m_parent);
         job->uiDelegate()->setAutoErrorHandlingEnabled(true);
     }
-#endif
 }
 
 void TreeViewContextMenu::showProperties()
diff --git a/src/views/dolphinview.cpp b/src/views/dolphinview.cpp
index 88f275557..c3ef4e0c6 100644
--- a/src/views/dolphinview.cpp
+++ b/src/views/dolphinview.cpp
@@ -48,11 +48,6 @@
 
 #include <kwidgetsaddons_version.h>
 
-#include <kio_version.h>
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-#include <KIO/DeleteOrTrashJob>
-#endif
-
 #include <QAbstractItemView>
 #include <QActionGroup>
 #include <QApplication>
@@ -757,13 +752,6 @@ void DolphinView::renameSelectedItems()
 void DolphinView::trashSelectedItems()
 {
     const QList<QUrl> list = simplifiedSelectedUrls();
-
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-    using Iface = KIO::AskUserActionInterface;
-    auto *trashJob = new KIO::DeleteOrTrashJob(list, Iface::Trash, Iface::DefaultConfirmation, this);
-    connect(trashJob, &KJob::result, this, &DolphinView::slotTrashFileFinished);
-    trashJob->start();
-#else
     KIO::JobUiDelegate uiDelegate;
     uiDelegate.setWindow(window());
     if (uiDelegate.askDeleteConfirmation(list, KIO::JobUiDelegate::Trash, KIO::JobUiDelegate::DefaultConfirmation)) {
@@ -773,19 +761,12 @@ void DolphinView::trashSelectedItems()
         connect(job, &KIO::Job::result,
                 this, &DolphinView::slotTrashFileFinished);
     }
-#endif
 }
 
 void DolphinView::deleteSelectedItems()
 {
     const QList<QUrl> list = simplifiedSelectedUrls();
 
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-    using Iface = KIO::AskUserActionInterface;
-    auto *trashJob = new KIO::DeleteOrTrashJob(list, Iface::Delete, Iface::DefaultConfirmation, this);
-    connect(trashJob, &KJob::result, this, &DolphinView::slotTrashFileFinished);
-    trashJob->start();
-#else
     KIO::JobUiDelegate uiDelegate;
     uiDelegate.setWindow(window());
     if (uiDelegate.askDeleteConfirmation(list, KIO::JobUiDelegate::Delete, KIO::JobUiDelegate::DefaultConfirmation)) {
@@ -794,7 +775,6 @@ void DolphinView::deleteSelectedItems()
         connect(job, &KIO::Job::result,
                 this, &DolphinView::slotDeleteFileFinished);
     }
-#endif
 }
 
 void DolphinView::cutSelectedItemsToClipboard()
-- 
GitLab


From 72fb5462931440a88ccf669d18cefdee97b685bf Mon Sep 17 00:00:00 2001
From: Felix Ernst <fe.a.ernst@gmail.com>
Date: Wed, 14 Dec 2022 14:31:45 +0100
Subject: [PATCH 3/3] Revert "DolphinTrash: port away from deprecated KIO API"

This reverts commit a0c0b43b97017280f6290fc720f41307a5b85d22.
---
 src/trash/dolphintrash.cpp | 40 ++++++++++++--------------------------
 src/trash/dolphintrash.h   |  2 +-
 2 files changed, 13 insertions(+), 29 deletions(-)

diff --git a/src/trash/dolphintrash.cpp b/src/trash/dolphintrash.cpp
index 236f9817d..1446ab388 100644
--- a/src/trash/dolphintrash.cpp
+++ b/src/trash/dolphintrash.cpp
@@ -7,20 +7,15 @@
 
 #include "dolphintrash.h"
 
+#include <KIO/JobUiDelegate>
+#include <kio_version.h>
+#include <KJobWidgets>
 #include <QList>
 #include <KNotification>
 #include <KConfig>
 #include <KConfigGroup>
 #include <KLocalizedString>
 
-#include <kio_version.h>
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-#include <KIO/DeleteOrTrashJob>
-#else
-#include <KIO/JobUiDelegate>
-#include <KJobWidgets>
-#endif
-
 Trash::Trash()
     : m_trashDirLister(new KDirLister())
 {
@@ -49,25 +44,8 @@ Trash &Trash::instance()
     return result;
 }
 
-static void notifyEmptied()
-{
-    // As long as KIO doesn't do this, do it ourselves
-    KNotification::event(QStringLiteral("Trash: emptied"),
-                         i18n("Trash Emptied"),
-                         i18n("The Trash was emptied."),
-                         QStringLiteral("user-trash"),
-                         nullptr,
-                         KNotification::DefaultEvent);
-}
-
-void Trash::empty(QWidget *window)
+KIO::Job *Trash::empty(QWidget *window)
 {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 100, 0)
-    using Iface = KIO::AskUserActionInterface;
-    auto *emptyJob = new KIO::DeleteOrTrashJob(QList<QUrl>{}, Iface::EmptyTrash, Iface::DefaultConfirmation, window);
-    QObject::connect(emptyJob, &KIO::Job::result, notifyEmptied);
-    emptyJob->start();
-#else
     KIO::JobUiDelegate uiDelegate;
     uiDelegate.setWindow(window);
     bool confirmed = uiDelegate.askDeleteConfirmation(QList<QUrl>(), KIO::JobUiDelegate::EmptyTrash, KIO::JobUiDelegate::DefaultConfirmation);
@@ -75,9 +53,15 @@ void Trash::empty(QWidget *window)
         KIO::Job* job = KIO::emptyTrash();
         KJobWidgets::setWindow(job, window);
         job->uiDelegate()->setAutoErrorHandlingEnabled(true);
-        QObject::connect(emptyJob, &KIO::Job::result, notifyEmptied);
+         // as long as KIO doesn't do this, do it ourselves
+        connect(job, &KIO::Job::result, []() {
+            KNotification::event(QStringLiteral("Trash: emptied"), i18n("Trash Emptied"),
+                                 i18n("The Trash was emptied."), QStringLiteral("user-trash"),
+                                 nullptr, KNotification::DefaultEvent);
+        });
+        return job;
     }
-#endif
+    return nullptr;
 }
 
 bool Trash::isEmpty()
diff --git a/src/trash/dolphintrash.h b/src/trash/dolphintrash.h
index c65cf9232..2ee85e89a 100644
--- a/src/trash/dolphintrash.h
+++ b/src/trash/dolphintrash.h
@@ -25,7 +25,7 @@ public:
     Trash& operator=(Trash &&) = delete;
 
     static Trash& instance();
-    static void empty(QWidget *window);
+    static KIO::Job* empty(QWidget *window);
     static bool isEmpty();
 
 Q_SIGNALS:
-- 
GitLab

