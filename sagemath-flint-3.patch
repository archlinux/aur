diff --git a/src/sage/features/sagemath.py b/src/sage/features/sagemath.py
index 7404e6d0a8e..6037d097391 100644
--- a/src/sage/features/sagemath.py
+++ b/src/sage/features/sagemath.py
@@ -761,7 +761,7 @@ class sage__rings__number_field(JoinFeature):
     A :class:`~sage.features.Feature` describing the presence of :mod:`sage.rings.number_field`.
 
     Number fields are implemented in Sage using a complicated mixture of various libraries,
-    including :ref:`arb <spkg_arb>`, :ref:`FLINT <spkg_flint>`, :ref:`GAP <spkg_gap>`,
+    including :ref:`FLINT <spkg_flint>`, :ref:`GAP <spkg_gap>`,
     :ref:`MPFI <spkg_mpfi>`, :ref:`NTL <spkg_ntl>`, and :ref:`PARI <spkg_pari>`.
 
     EXAMPLES:

From 51c9bb951320a49470ffcacbdee95df33f3d0647 Mon Sep 17 00:00:00 2001
From: Marc Mezzarobba <marc@mezzarobba.net>
Date: Mon, 9 Oct 2023 15:32:43 +0200
Subject: [PATCH 2/7] make sagelib build with flint3

---
 pkgs/sage-conf/_sage_conf/_conf.py.in         |  2 -
 src/sage/env.py                               |  6 +--
 src/sage/libs/arb/acb.pxd                     |  2 +-
 src/sage/libs/arb/acb_calc.pxd                |  2 +-
 src/sage/libs/arb/acb_elliptic.pxd            |  2 +-
 src/sage/libs/arb/acb_hypgeom.pxd             |  2 +-
 src/sage/libs/arb/acb_modular.pxd             |  2 +-
 src/sage/libs/arb/acb_poly.pxd                | 20 +------
 src/sage/libs/arb/arb.pxd                     |  2 +-
 src/sage/libs/arb/arb_fmpz_poly.pxd           |  3 +-
 src/sage/libs/arb/arb_hypgeom.pxd             |  2 +-
 src/sage/libs/arb/arb_wrap.h                  | 26 ++++-----
 src/sage/libs/arb/arf.pxd                     |  4 +-
 src/sage/libs/arb/bernoulli.pxd               |  2 +-
 src/sage/libs/arb/mag.pxd                     |  4 +-
 src/sage/libs/flint/flint_wrap.h              |  1 +
 src/sage/libs/flint/fmpq.pxd                  |  2 +
 src/sage/libs/flint/fmpq_poly.pxd             | 23 ++++----
 src/sage/libs/flint/fmpq_poly.pyx             | 45 ++++++++++++++++
 src/sage/libs/flint/fmpz.pxd                  |  3 ++
 src/sage/libs/flint/fmpz_mod_poly.pxd         | 54 -------------------
 src/sage/libs/flint/fmpz_poly.pxd             | 16 +++---
 src/sage/libs/flint/fmpz_poly.pyx             | 43 ++++++++++++++-
 src/sage/libs/flint/fmpz_poly_q.pxd           |  7 ---
 .../libs/linbox/linbox_flint_interface.pyx    |  5 +-
 src/sage/matrix/matrix_complex_ball_dense.pyx |  2 +-
 src/sage/matrix/matrix_integer_sparse.pyx     |  8 ++-
 .../polynomial/polynomial_rational_flint.pyx  | 40 +++++++++-----
 src/sage/symbolic/ginac/inifcns_orthopoly.cpp |  5 +-
 src/sage/symbolic/ginac/useries.cpp           | 50 ++++++++++++-----
 src/sage_setup/library_order.py               |  7 +--
 31 files changed, 216 insertions(+), 176 deletions(-)
 create mode 100644 src/sage/libs/flint/fmpq_poly.pyx

diff --git a/pkgs/sage-conf/_sage_conf/_conf.py.in b/pkgs/sage-conf/_sage_conf/_conf.py.in
index 87b27ca05cb..895d6572d1e 100644
--- a/pkgs/sage-conf/_sage_conf/_conf.py.in
+++ b/pkgs/sage-conf/_sage_conf/_conf.py.in
@@ -19,8 +19,6 @@ MAXIMA_FAS = "@SAGE_MAXIMA_FAS@".replace('${prefix}', SAGE_LOCAL)
 # Delete this line if your ECL can load Kenzo without further prodding.
 KENZO_FAS = "@SAGE_KENZO_FAS@".replace('${prefix}', SAGE_LOCAL)
 
-ARB_LIBRARY = "@SAGE_ARB_LIBRARY@"
-
 NTL_INCDIR = "@NTL_INCDIR@"
 NTL_LIBDIR = "@NTL_LIBDIR@"
 
diff --git a/src/sage/env.py b/src/sage/env.py
index b1fe9a89cd1..9197fc3a703 100644
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -223,7 +223,6 @@ def var(key: str, *fallbacks: Optional[str], force: bool = False) -> Optional[st
 FOURTITWO_PPI = var("FOURTITWO_PPI")
 FOURTITWO_CIRCUITS = var("FOURTITWO_CIRCUITS")
 FOURTITWO_GROEBNER = var("FOURTITWO_GROEBNER")
-ARB_LIBRARY = var("ARB_LIBRARY", "arb")
 CBLAS_PC_MODULES = var("CBLAS_PC_MODULES", "cblas:openblas:blas")
 ECL_CONFIG = var("ECL_CONFIG", "ecl-config")
 NTL_INCDIR = var("NTL_INCDIR")
@@ -356,8 +355,7 @@ def cython_aliases(required_modules=None,
         sage: cython_aliases()
         {...}
         sage: sorted(cython_aliases().keys())
-        ['ARB_LIBRARY',
-         'CBLAS_CFLAGS',
+        ['CBLAS_CFLAGS',
          ...,
          'ZLIB_LIBRARIES']
         sage: cython_aliases(required_modules=('module-that-is-assumed-to-not-exist'))
@@ -475,8 +473,6 @@ def uname_specific(name, value, alternative):
     if "LINBOX_CFLAGS" in aliases:
         aliases["LINBOX_CFLAGS"].append("-std=gnu++11")
 
-    aliases["ARB_LIBRARY"] = ARB_LIBRARY
-
     # TODO: Remove Cygwin hack by installing a suitable cblas.pc
     if os.path.exists('/usr/lib/libblas.dll.a'):
         aliases["CBLAS_LIBS"] = ['gslcblas']
diff --git a/src/sage/libs/arb/acb.pxd b/src/sage/libs/arb/acb.pxd
index 5148dc43991..3f53b96d331 100644
--- a/src/sage/libs/arb/acb.pxd
+++ b/src/sage/libs/arb/acb.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/acb_calc.pxd b/src/sage/libs/arb/acb_calc.pxd
index a5dbf360b5e..67bd2ed57dc 100644
--- a/src/sage/libs/arb/acb_calc.pxd
+++ b/src/sage/libs/arb/acb_calc.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb_calc.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/acb_elliptic.pxd b/src/sage/libs/arb/acb_elliptic.pxd
index 176f68df00e..e3480e9f73b 100644
--- a/src/sage/libs/arb/acb_elliptic.pxd
+++ b/src/sage/libs/arb/acb_elliptic.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb_elliptic.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/acb_hypgeom.pxd b/src/sage/libs/arb/acb_hypgeom.pxd
index 418e766f10d..c43e5c0623b 100644
--- a/src/sage/libs/arb/acb_hypgeom.pxd
+++ b/src/sage/libs/arb/acb_hypgeom.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb_hypgeom.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/acb_modular.pxd b/src/sage/libs/arb/acb_modular.pxd
index c708e9bf97d..cdc413c92da 100644
--- a/src/sage/libs/arb/acb_modular.pxd
+++ b/src/sage/libs/arb/acb_modular.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb_modular.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/acb_poly.pxd b/src/sage/libs/arb/acb_poly.pxd
index 69f4320055b..ae02757ffd9 100644
--- a/src/sage/libs/arb/acb_poly.pxd
+++ b/src/sage/libs/arb/acb_poly.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = acb_poly.h
 
 from sage.libs.arb.types cimport *
@@ -79,24 +79,10 @@ cdef extern from "arb_wrap.h":
     void _acb_poly_divrem(acb_ptr Q, acb_ptr R, acb_srcptr A, long lenA, acb_srcptr B, long lenB, long prec)
     bint acb_poly_divrem(acb_poly_t Q, acb_poly_t R, const acb_poly_t A, const acb_poly_t B, long prec)
     void _acb_poly_div_root(acb_ptr Q, acb_t R, acb_srcptr A, long len, const acb_t c, long prec)
-    void _acb_poly_taylor_shift_horner(acb_ptr g, const acb_t c, long n, long prec)
-    void acb_poly_taylor_shift_horner(acb_poly_t g, const acb_poly_t f, const acb_t c, long prec)
-    void _acb_poly_taylor_shift_divconquer(acb_ptr g, const acb_t c, long n, long prec)
-    void acb_poly_taylor_shift_divconquer(acb_poly_t g, const acb_poly_t f, const acb_t c, long prec)
-    void _acb_poly_taylor_shift_convolution(acb_ptr g, const acb_t c, long n, long prec)
-    void acb_poly_taylor_shift_convolution(acb_poly_t g, const acb_poly_t f, const acb_t c, long prec)
     void _acb_poly_taylor_shift(acb_ptr g, const acb_t c, long n, long prec)
     void acb_poly_taylor_shift(acb_poly_t g, const acb_poly_t f, const acb_t c, long prec)
-    void _acb_poly_compose_horner(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long prec)
-    void acb_poly_compose_horner(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long prec)
-    void _acb_poly_compose_divconquer(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long prec)
-    void acb_poly_compose_divconquer(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long prec)
     void _acb_poly_compose(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long prec)
     void acb_poly_compose(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long prec)
-    void _acb_poly_compose_series_horner(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long n, long prec)
-    void acb_poly_compose_series_horner(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long n, long prec)
-    void _acb_poly_compose_series_brent_kung(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long n, long prec)
-    void acb_poly_compose_series_brent_kung(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long n, long prec)
     void _acb_poly_compose_series(acb_ptr res, acb_srcptr poly1, long len1, acb_srcptr poly2, long len2, long n, long prec)
     void acb_poly_compose_series(acb_poly_t res, const acb_poly_t poly1, const acb_poly_t poly2, long n, long prec)
     void _acb_poly_revert_series_lagrange(acb_ptr h, acb_srcptr f, long flen, long n, long prec)
@@ -161,10 +147,6 @@ cdef extern from "arb_wrap.h":
     void acb_poly_exp_series_basecase(acb_poly_t f, const acb_poly_t h, long n, long prec)
     void _acb_poly_exp_series(acb_ptr f, acb_srcptr h, long hlen, long n, long prec)
     void acb_poly_exp_series(acb_poly_t f, const acb_poly_t h, long n, long prec)
-    void _acb_poly_sin_cos_series_basecase(acb_ptr s, acb_ptr c, acb_srcptr h, long hlen, long n, long prec, int times_pi)
-    void acb_poly_sin_cos_series_basecase(acb_poly_t s, acb_poly_t c, const acb_poly_t h, long n, long prec, int times_pi)
-    void _acb_poly_sin_cos_series_tangent(acb_ptr s, acb_ptr c, acb_srcptr h, long hlen, long n, long prec, int times_pi)
-    void acb_poly_sin_cos_series_tangent(acb_poly_t s, acb_poly_t c, const acb_poly_t h, long n, long prec, int times_pi)
     void _acb_poly_sin_cos_series(acb_ptr s, acb_ptr c, acb_srcptr h, long hlen, long n, long prec)
     void acb_poly_sin_cos_series(acb_poly_t s, acb_poly_t c, const acb_poly_t h, long n, long prec)
     void _acb_poly_sin_series(acb_ptr s, acb_srcptr h, long hlen, long n, long prec)
diff --git a/src/sage/libs/arb/arb.pxd b/src/sage/libs/arb/arb.pxd
index c82b94de30f..33083fc125f 100644
--- a/src/sage/libs/arb/arb.pxd
+++ b/src/sage/libs/arb/arb.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = arb.h
 
 from sage.libs.arb.types cimport *
diff --git a/src/sage/libs/arb/arb_fmpz_poly.pxd b/src/sage/libs/arb/arb_fmpz_poly.pxd
index 079f76e9d9e..55daa705238 100644
--- a/src/sage/libs/arb/arb_fmpz_poly.pxd
+++ b/src/sage/libs/arb/arb_fmpz_poly.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = arb_fmpz_poly.h
 
 from sage.libs.arb.types cimport *
@@ -22,5 +22,4 @@ cdef extern from "arb_wrap.h":
     unsigned long arb_fmpz_poly_deflation(const fmpz_poly_t poly)
     void arb_fmpz_poly_deflate(fmpz_poly_t res, const fmpz_poly_t poly, unsigned long deflation)
     void arb_fmpz_poly_complex_roots(acb_ptr roots, const fmpz_poly_t poly, int flags, long prec)
-    void arb_fmpz_poly_cos_minpoly(fmpz_poly_t res, unsigned long n)
     void arb_fmpz_poly_gauss_period_minpoly(fmpz_poly_t res, unsigned long q, unsigned long n)
diff --git a/src/sage/libs/arb/arb_hypgeom.pxd b/src/sage/libs/arb/arb_hypgeom.pxd
index fb1c40ddaa8..139b987d669 100644
--- a/src/sage/libs/arb/arb_hypgeom.pxd
+++ b/src/sage/libs/arb/arb_hypgeom.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = arb_hypgeom.h
 
 from sage.libs.flint.types cimport fmpz_t
diff --git a/src/sage/libs/arb/arb_wrap.h b/src/sage/libs/arb/arb_wrap.h
index 49997075ee5..f51c89ffe38 100644
--- a/src/sage/libs/arb/arb_wrap.h
+++ b/src/sage/libs/arb/arb_wrap.h
@@ -11,19 +11,19 @@
 #define ulong mp_limb_t
 #define slong mp_limb_signed_t
 
-#include <acb.h>
-#include <acb_calc.h>
-#include <acb_elliptic.h>
-#include <acb_hypgeom.h>
-#include <acb_mat.h>
-#include <acb_modular.h>
-#include <acb_poly.h>
-#include <arb.h>
-#include <arb_fmpz_poly.h>
-#include <arb_hypgeom.h>
-#include <arf.h>
-#include <bernoulli.h>
-#include <mag.h>
+#include <flint/acb.h>
+#include <flint/acb_calc.h>
+#include <flint/acb_elliptic.h>
+#include <flint/acb_hypgeom.h>
+#include <flint/acb_mat.h>
+#include <flint/acb_modular.h>
+#include <flint/acb_poly.h>
+#include <flint/arb.h>
+#include <flint/arb_fmpz_poly.h>
+#include <flint/arb_hypgeom.h>
+#include <flint/arf.h>
+#include <flint/bernoulli.h>
+#include <flint/mag.h>
 
 #undef ulong
 #undef slong
diff --git a/src/sage/libs/arb/arf.pxd b/src/sage/libs/arb/arf.pxd
index b8b83fefcdc..84778fe9f09 100644
--- a/src/sage/libs/arb/arf.pxd
+++ b/src/sage/libs/arb/arf.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = arf.h
 
 from sage.libs.arb.types cimport *
@@ -30,7 +30,6 @@ cdef extern from "arb_wrap.h":
     void arf_set_ui(arf_t y, unsigned long x)
     void arf_set_si(arf_t y, long x)
     void arf_set_mpfr(arf_t y, const mpfr_t x)
-    # void arf_set_fmpr(arf_t y, const fmpr_t x)
     void arf_set_d(arf_t y, double x)
     void arf_swap(arf_t y, arf_t x)
     void arf_init_set_ui(arf_t y, unsigned long x)
@@ -46,7 +45,6 @@ cdef extern from "arb_wrap.h":
     int arf_set_round_fmpz_2exp(arf_t y, const fmpz_t x, const fmpz_t e, long prec, arf_rnd_t rnd)
     void arf_get_fmpz_2exp(fmpz_t m, fmpz_t e, const arf_t x)
     double arf_get_d(const arf_t x, arf_rnd_t rnd)
-    # void arf_get_fmpr(fmpr_t y, const arf_t x)
     int arf_get_mpfr(mpfr_t y, const arf_t x, mpfr_rnd_t rnd)
     void arf_get_fmpz(fmpz_t z, const arf_t x, arf_rnd_t rnd)
     long arf_get_si(const arf_t x, arf_rnd_t rnd)
diff --git a/src/sage/libs/arb/bernoulli.pxd b/src/sage/libs/arb/bernoulli.pxd
index 375b2b9bbcf..ea9340f4b15 100644
--- a/src/sage/libs/arb/bernoulli.pxd
+++ b/src/sage/libs/arb/bernoulli.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = bernoulli.h
 
 from ..flint.types cimport fmpq_t, ulong
diff --git a/src/sage/libs/arb/mag.pxd b/src/sage/libs/arb/mag.pxd
index d5d8693ea8f..69dfb990ae0 100644
--- a/src/sage/libs/arb/mag.pxd
+++ b/src/sage/libs/arb/mag.pxd
@@ -1,4 +1,4 @@
-# distutils: libraries = gmp flint ARB_LIBRARY
+# distutils: libraries = gmp flint
 # distutils: depends = mag.h
 
 from sage.libs.arb.types cimport *
@@ -27,13 +27,11 @@ cdef extern from "arb_wrap.h":
     # void mag_randtest(mag_t x, flint_rand_t state, long expbits)
     # void mag_randtest_special(mag_t x, flint_rand_t state, long expbits)
     void mag_set_d(mag_t y, double x)
-    # void mag_set_fmpr(mag_t y, const fmpr_t x)
     void mag_set_ui(mag_t y, unsigned long x)
     void mag_set_fmpz(mag_t y, const fmpz_t x)
     void mag_set_d_2exp_fmpz(mag_t z, double x, const fmpz_t y)
     void mag_set_fmpz_2exp_fmpz(mag_t z, const fmpz_t x, const fmpz_t y)
     void mag_set_ui_2exp_si(mag_t z, unsigned long x, long y)
-    # void mag_get_fmpr(fmpr_t y, const mag_t x)
     void mag_get_fmpq(fmpq_t y, const mag_t x)
     void mag_set_ui_lower(mag_t z, unsigned long x)
     void mag_set_fmpz_lower(mag_t z, const fmpz_t x)
diff --git a/src/sage/libs/flint/flint_wrap.h b/src/sage/libs/flint/flint_wrap.h
index 266535c3835..a416d5b53db 100644
--- a/src/sage/libs/flint/flint_wrap.h
+++ b/src/sage/libs/flint/flint_wrap.h
@@ -47,6 +47,7 @@
 #include <flint/fq.h>
 #include <flint/fq_nmod.h>
 #include <flint/nmod_poly.h>
+#include <flint/nmod_poly_factor.h>
 #include <flint/nmod_vec.h>
 #include <flint/padic.h>
 #include <flint/padic_poly.h>
diff --git a/src/sage/libs/flint/fmpq.pxd b/src/sage/libs/flint/fmpq.pxd
index 5e64c82102f..0616c0a7408 100644
--- a/src/sage/libs/flint/fmpq.pxd
+++ b/src/sage/libs/flint/fmpq.pxd
@@ -12,6 +12,8 @@ cdef extern from "flint_wrap.h":
     fmpz * fmpq_denref(fmpq_t)
     void fmpq_init(fmpq_t)
     void fmpq_clear(fmpq_t)
+    void fmpq_init_set_readonly(fmpq_t, const mpq_t)
+    void fmpq_clear_readonly(fmpq_t)
     void fmpq_one(fmpq_t)
     void fmpq_zero(fmpq_t)
     bint fmpq_is_zero(fmpq_t)
diff --git a/src/sage/libs/flint/fmpq_poly.pxd b/src/sage/libs/flint/fmpq_poly.pxd
index 6050c487835..afa16e5bbdd 100644
--- a/src/sage/libs/flint/fmpq_poly.pxd
+++ b/src/sage/libs/flint/fmpq_poly.pxd
@@ -30,6 +30,9 @@ cdef extern from "flint_wrap.h":
     void fmpq_poly_canonicalise(fmpq_poly_t)
     int fmpq_poly_is_canonical(const fmpq_poly_t)
 
+    void _fmpq_poly_set_length(fmpq_poly_t, slong)
+    void _fmpq_poly_normalise(fmpq_poly_t)
+
     # Polynomial parameters
     slong fmpq_poly_degree(const fmpq_poly_t)
     ulong fmpq_poly_length(const fmpq_poly_t)
@@ -46,10 +49,7 @@ cdef extern from "flint_wrap.h":
     void fmpq_poly_set_ui(fmpq_poly_t, ulong)
     void fmpq_poly_set_fmpz(fmpq_poly_t, const fmpz_t)
     void fmpq_poly_set_fmpq(fmpq_poly_t, const fmpq_t)
-    void fmpq_poly_set_mpz(fmpq_poly_t, const mpz_t)
-    void fmpq_poly_set_mpq(fmpq_poly_t, const mpq_t)
     void fmpq_poly_set_fmpz_poly(fmpq_poly_t, const fmpz_poly_t)
-    void fmpq_poly_set_array_mpq(fmpq_poly_t, const mpq_t *, slong)
 
     void fmpq_poly_set_str(fmpq_poly_t, const char *)
     char *fmpq_poly_get_str(const fmpq_poly_t)
@@ -67,7 +67,6 @@ cdef extern from "flint_wrap.h":
     void fmpq_poly_reverse(fmpq_poly_t, const fmpq_poly_t, slong)
 
     void fmpq_poly_get_coeff_fmpq(fmpq_t, const fmpq_poly_t, slong)
-    void fmpq_poly_get_coeff_mpq(mpq_t, const fmpq_poly_t, slong)
     void fmpq_poly_get_coeff_si(slong, const fmpq_poly_t, slong)
     void fmpq_poly_get_coeff_ui(ulong, const fmpq_poly_t, slong)
 
@@ -75,8 +74,6 @@ cdef extern from "flint_wrap.h":
     void fmpq_poly_set_coeff_ui(fmpq_poly_t, slong, ulong)
     void fmpq_poly_set_coeff_fmpz(fmpq_poly_t, slong, const fmpz_t)
     void fmpq_poly_set_coeff_fmpq(fmpq_poly_t, slong, const fmpq_t)
-    void fmpq_poly_set_coeff_mpz(fmpq_poly_t, slong, const mpz_t)
-    void fmpq_poly_set_coeff_mpq(fmpq_poly_t, slong, const mpq_t)
 
     # Comparison
     int fmpq_poly_equal(const fmpq_poly_t, const fmpq_poly_t)
@@ -100,8 +97,6 @@ cdef extern from "flint_wrap.h":
             fmpq_poly_t, const fmpq_poly_t, const fmpz_t)
     void fmpq_poly_scalar_mul_fmpq(
             fmpq_poly_t, const fmpq_poly_t, const fmpq_t)
-    void fmpq_poly_scalar_mul_mpz(fmpq_poly_t, const fmpq_poly_t, const mpz_t)
-    void fmpq_poly_scalar_mul_mpq(fmpq_poly_t, const fmpq_poly_t, const mpq_t)
 
     void fmpq_poly_scalar_div_si(fmpq_poly_t, const fmpq_poly_t, slong)
     void fmpq_poly_scalar_div_ui(fmpq_poly_t, const fmpq_poly_t, ulong)
@@ -109,8 +104,6 @@ cdef extern from "flint_wrap.h":
             fmpq_poly_t, const fmpq_poly_t, const fmpz_t)
     void fmpq_poly_scalar_div_fmpq(
             fmpq_poly_t, const fmpq_poly_t, const fmpq_t)
-    void fmpq_poly_scalar_div_mpz(fmpq_poly_t, const fmpq_poly_t, const mpz_t)
-    void fmpq_poly_scalar_div_mpq(fmpq_poly_t, const fmpq_poly_t, const mpq_t)
 
     # Multiplication
     void fmpq_poly_mul(fmpq_poly_t, const fmpq_poly_t, const fmpq_poly_t)
@@ -155,8 +148,6 @@ cdef extern from "flint_wrap.h":
     # Evaluation
     void fmpq_poly_evaluate_fmpz(fmpq_t, const fmpq_poly_t, const fmpz_t)
     void fmpq_poly_evaluate_fmpq(fmpq_t, const fmpq_poly_t, const fmpq_t)
-    void fmpq_poly_evaluate_mpz(mpq_t, const fmpq_poly_t, const mpz_t)
-    void fmpq_poly_evaluate_mpq(mpq_t, const fmpq_poly_t, const mpq_t)
 
     # Composition
     void fmpq_poly_compose(fmpq_poly_t, const fmpq_poly_t, const fmpq_poly_t)
@@ -189,3 +180,11 @@ cdef extern from "flint_wrap.h":
 # since the fmpq_poly header seems to be lacking this inline function
 cdef inline sage_fmpq_poly_max_limbs(const fmpq_poly_t poly) noexcept:
     return _fmpz_vec_max_limbs(fmpq_poly_numref(poly), fmpq_poly_length(poly))
+
+# functions removed from flint but still needed in sage
+cdef void fmpq_poly_scalar_mul_mpz(fmpq_poly_t, const fmpq_poly_t, const mpz_t)
+cdef void fmpq_poly_scalar_mul_mpq(fmpq_poly_t, const fmpq_poly_t, const mpq_t)
+cdef void fmpq_poly_set_coeff_mpq(fmpq_poly_t, slong, const mpq_t)
+cdef void fmpq_poly_get_coeff_mpq(mpq_t, const fmpq_poly_t, slong)
+cdef void fmpq_poly_set_mpz(fmpq_poly_t, const mpz_t)
+cdef void fmpq_poly_set_mpq(fmpq_poly_t, const mpq_t)
diff --git a/src/sage/libs/flint/fmpq_poly.pyx b/src/sage/libs/flint/fmpq_poly.pyx
new file mode 100644
index 00000000000..3b8a0cf0c51
--- /dev/null
+++ b/src/sage/libs/flint/fmpq_poly.pyx
@@ -0,0 +1,45 @@
+# Functions removed from flint but still needed in Sage. Code adapted from
+# earlier versions of flint.
+
+from sage.libs.gmp.mpq cimport *
+from sage.libs.flint.fmpz cimport *
+from sage.libs.flint.fmpq cimport *
+
+cdef void fmpq_poly_scalar_mul_mpz(fmpq_poly_t rop, const fmpq_poly_t op, const mpz_t c):
+    cdef fmpz_t f
+    fmpz_init_set_readonly(f, c)
+    fmpq_poly_scalar_mul_fmpz(rop, op, f)
+    fmpz_clear_readonly(f)
+
+cdef void fmpq_poly_scalar_mul_mpq(fmpq_poly_t rop, const fmpq_poly_t op, const mpq_t c):
+    cdef fmpq_t f
+    fmpq_init_set_readonly(f, c)
+    fmpq_poly_scalar_mul_fmpq(rop, op, f)
+    fmpq_clear_readonly(f)
+
+cdef void fmpq_poly_set_coeff_mpq(fmpq_poly_t poly, slong n, const mpq_t x):
+    cdef fmpq_t t
+    fmpq_init_set_readonly(t, x)
+    fmpq_poly_set_coeff_fmpq(poly, n, t)
+    fmpq_clear_readonly(t)
+
+cdef void fmpq_poly_get_coeff_mpq(mpq_t x, const fmpq_poly_t poly, slong n):
+    cdef fmpq_t t
+    fmpq_init(t)
+    fmpq_poly_get_coeff_fmpq(t, poly, n)
+    fmpq_get_mpq(x, t)
+    fmpq_clear(t)
+
+cdef void fmpq_poly_set_mpq(fmpq_poly_t poly, const mpq_t x):
+    fmpq_poly_fit_length(poly, 1)
+    fmpz_set_mpz(fmpq_poly_numref(poly), mpq_numref(x))
+    fmpz_set_mpz(fmpq_poly_denref(poly), mpq_denref(x))
+    _fmpq_poly_set_length(poly, 1)
+    _fmpq_poly_normalise(poly)
+
+cdef void fmpq_poly_set_mpz(fmpq_poly_t poly, const mpz_t x):
+    fmpq_poly_fit_length(poly, 1)
+    fmpz_set_mpz(fmpq_poly_numref(poly), x)
+    fmpz_one(fmpq_poly_denref(poly))
+    _fmpq_poly_set_length(poly, 1)
+    _fmpq_poly_normalise(poly)
diff --git a/src/sage/libs/flint/fmpz.pxd b/src/sage/libs/flint/fmpz.pxd
index 01058d0f130..b97fbe1eae0 100644
--- a/src/sage/libs/flint/fmpz.pxd
+++ b/src/sage/libs/flint/fmpz.pxd
@@ -16,6 +16,9 @@ cdef extern from "flint_wrap.h":
     void fmpz_init_set(fmpz_t, fmpz_t)
     void fmpz_init_set_ui(fmpz_t, ulong)
 
+    void fmpz_init_set_readonly(fmpz_t, const mpz_t)
+    void fmpz_clear_readonly(fmpz_t)
+
     # Conversion
     void fmpz_set(fmpz_t f, fmpz_t g)
     void fmpz_set_ui(fmpz_t, ulong)
diff --git a/src/sage/libs/flint/fmpz_mod_poly.pxd b/src/sage/libs/flint/fmpz_mod_poly.pxd
index 24b653eb3b7..2727246da98 100644
--- a/src/sage/libs/flint/fmpz_mod_poly.pxd
+++ b/src/sage/libs/flint/fmpz_mod_poly.pxd
@@ -67,13 +67,6 @@ cdef extern from "flint_wrap.h":
     void fmpz_mod_poly_get_coeff_fmpz(fmpz_t x, const fmpz_mod_poly_t poly,
                                              slong n, const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_set_coeff_mpz(fmpz_mod_poly_t poly,
-                             slong n, const mpz_t x, const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_get_coeff_mpz(mpz_t x,
-                 const fmpz_mod_poly_t poly, slong n, const fmpz_mod_ctx_t ctx)
-
-
     void _fmpz_mod_poly_shift_left(fmpz * res, const fmpz * poly,
                                                            slong len, slong n)
 
@@ -194,14 +187,6 @@ cdef extern from "flint_wrap.h":
                              const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
                                                      const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_div_basecase(fmpz_mod_poly_t Q,
-                            const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_div_newton_n_preinv(fmpz_mod_poly_t Q,
-                         const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                         const fmpz_mod_poly_t Binv, const fmpz_mod_ctx_t ctx)
-
     void fmpz_mod_poly_divrem_newton_n_preinv(fmpz_mod_poly_t Q,
           fmpz_mod_poly_t R, const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
                          const fmpz_mod_poly_t Binv, const fmpz_mod_ctx_t ctx)
@@ -213,10 +198,6 @@ cdef extern from "flint_wrap.h":
                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
                                                      const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_divrem_divconquer(fmpz_mod_poly_t Q,
-        fmpz_mod_poly_t R, const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
     void fmpz_mod_poly_divrem(fmpz_mod_poly_t Q, fmpz_mod_poly_t R,
     const fmpz_mod_poly_t A, const fmpz_mod_poly_t B, const fmpz_mod_ctx_t ctx)
 
@@ -254,40 +235,13 @@ cdef extern from "flint_wrap.h":
     void fmpz_mod_poly_make_monic_f(fmpz_t f, fmpz_mod_poly_t res,
                          const fmpz_mod_poly_t poly, const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_gcd_euclidean(fmpz_mod_poly_t G,
-                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_gcd_euclidean_f(fmpz_t f, fmpz_mod_poly_t G,
-                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
     void fmpz_mod_poly_gcd_f(fmpz_t f, fmpz_mod_poly_t G, const fmpz_mod_poly_t A,
                              const fmpz_mod_poly_t B, const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_gcd_hgcd(fmpz_mod_poly_t G,
-                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
-
     void fmpz_mod_poly_gcd(fmpz_mod_poly_t G, const fmpz_mod_poly_t A,
                              const fmpz_mod_poly_t B, const fmpz_mod_ctx_t ctx)
 
 
-    void fmpz_mod_poly_xgcd_euclidean(fmpz_mod_poly_t G,
-                             fmpz_mod_poly_t S, fmpz_mod_poly_t T,
-                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_xgcd_euclidean_f(fmpz_t f, fmpz_mod_poly_t G,
-                             fmpz_mod_poly_t S, fmpz_mod_poly_t T,
-                             const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_xgcd_hgcd(fmpz_mod_poly_t G, fmpz_mod_poly_t S,
-          fmpz_mod_poly_t T, const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
-                                                     const fmpz_mod_ctx_t ctx)
-
     void fmpz_mod_poly_xgcd(fmpz_mod_poly_t G, fmpz_mod_poly_t S, fmpz_mod_poly_t T,
                              const fmpz_mod_poly_t A, const fmpz_mod_poly_t B,
                                                       const fmpz_mod_ctx_t ctx)
@@ -361,14 +315,6 @@ cdef extern from "flint_wrap.h":
                         const fmpz_mod_poly_t poly, const fmpz * xs, slong n,
                                                      const fmpz_mod_ctx_t ctx)
 
-    void fmpz_mod_poly_compose_horner(fmpz_mod_poly_t res,
-                    const fmpz_mod_poly_t poly1, const fmpz_mod_poly_t poly2,
-                                                     const fmpz_mod_ctx_t ctx)
-
-    void fmpz_mod_poly_compose_divconquer(fmpz_mod_poly_t res,
-                     const fmpz_mod_poly_t poly1, const fmpz_mod_poly_t poly2,
-                                                     const fmpz_mod_ctx_t ctx)
-
     void fmpz_mod_poly_compose(fmpz_mod_poly_t res, const fmpz_mod_poly_t poly1,
                          const fmpz_mod_poly_t poly2, const fmpz_mod_ctx_t ctx)
 
diff --git a/src/sage/libs/flint/fmpz_poly.pxd b/src/sage/libs/flint/fmpz_poly.pxd
index 18b36672d30..c8bc6d3ca0a 100644
--- a/src/sage/libs/flint/fmpz_poly.pxd
+++ b/src/sage/libs/flint/fmpz_poly.pxd
@@ -28,7 +28,6 @@ cdef extern from "flint_wrap.h":
     void fmpz_poly_set_ui(fmpz_poly_t, ulong)
     void fmpz_poly_set_si(fmpz_poly_t, slong)
     void fmpz_poly_set_fmpz(fmpz_poly_t, const fmpz_t)
-    void fmpz_poly_set_mpz(fmpz_poly_t, const mpz_t)
     int fmpz_poly_set_str(fmpz_poly_t, const char *)
 
     char *fmpz_poly_get_str(const fmpz_poly_t)
@@ -70,7 +69,6 @@ cdef extern from "flint_wrap.h":
     # Scalar multiplication and division
     void fmpz_poly_scalar_mul_fmpz(
             fmpz_poly_t, const fmpz_poly_t, const fmpz_t)
-    void fmpz_poly_scalar_mul_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
     void fmpz_poly_scalar_mul_si(fmpz_poly_t, const fmpz_poly_t, slong)
     void fmpz_poly_scalar_mul_ui(fmpz_poly_t, const fmpz_poly_t, ulong)
     void fmpz_poly_scalar_mul_2exp(fmpz_poly_t, const fmpz_poly_t, ulong)
@@ -310,12 +308,14 @@ cdef extern from "flint_wrap.h":
             fmpz_poly_t,
                     const fmpz_poly_t, const fmpz_t, const nmod_poly_t, int)
 
-    # Some functions for backwards compatibility
-    void fmpz_poly_scalar_mul_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
-    void fmpz_poly_scalar_divexact_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
-    void fmpz_poly_scalar_fdiv_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
-    void fmpz_poly_set_coeff_mpz(fmpz_poly_t, slong, const mpz_t)
-    void fmpz_poly_get_coeff_mpz(mpz_t, const fmpz_poly_t, slong)
+
+# functions removed from flint but still needed in sage
+cdef void fmpz_poly_scalar_mul_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
+cdef void fmpz_poly_scalar_divexact_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
+cdef void fmpz_poly_scalar_fdiv_mpz(fmpz_poly_t, const fmpz_poly_t, const mpz_t)
+cdef void fmpz_poly_set_coeff_mpz(fmpz_poly_t, slong, const mpz_t)
+cdef void fmpz_poly_get_coeff_mpz(mpz_t, const fmpz_poly_t, slong)
+cdef void fmpz_poly_set_mpz(fmpz_poly_t, const mpz_t)
 
 
 # Wrapper Cython class
diff --git a/src/sage/libs/flint/fmpz_poly.pyx b/src/sage/libs/flint/fmpz_poly.pyx
index 74915b37612..cfcbea9090c 100644
--- a/src/sage/libs/flint/fmpz_poly.pyx
+++ b/src/sage/libs/flint/fmpz_poly.pyx
@@ -25,10 +25,10 @@ from cysignals.memory cimport sig_free
 
 from sage.arith.long cimport pyobject_to_long
 from sage.cpython.string cimport char_to_str, str_to_bytes
+from sage.libs.flint.fmpz cimport *
 from sage.structure.sage_object cimport SageObject
 from sage.rings.integer cimport Integer
 
-
 cdef class Fmpz_poly(SageObject):
 
     def __cinit__(self):
@@ -455,3 +455,44 @@ cdef class Fmpz_poly(SageObject):
         """
         from sage.rings.integer_ring import ZZ
         return ZZ[var](self.list())
+
+
+# Functions removed from flint but still needed in Sage. Code adapted from
+# earlier versions of flint.
+
+cdef void fmpz_poly_scalar_mul_mpz(fmpz_poly_t rop, const fmpz_poly_t op, const mpz_t c):
+    cdef fmpz_t f
+    fmpz_init_set_readonly(f, c)
+    fmpz_poly_scalar_mul_fmpz(rop, op, f)
+    fmpz_clear_readonly(f)
+
+cdef void fmpz_poly_scalar_divexact_mpz(fmpz_poly_t rop, const fmpz_poly_t op, const mpz_t c):
+    cdef fmpz_t f
+    fmpz_init_set_readonly(f, c)
+    fmpz_poly_scalar_divexact_fmpz(rop, op, f)
+    fmpz_clear_readonly(f)
+
+cdef void fmpz_poly_scalar_fdiv_mpz(fmpz_poly_t rop, const fmpz_poly_t op, const mpz_t c):
+    cdef fmpz_t f
+    fmpz_init_set_readonly(f, c)
+    fmpz_poly_scalar_fdiv_fmpz(rop, op, f)
+    fmpz_clear_readonly(f)
+
+cdef void fmpz_poly_set_coeff_mpz(fmpz_poly_t poly, slong n, const mpz_t x):
+    cdef fmpz_t t
+    fmpz_init_set_readonly(t, x)
+    fmpz_poly_set_coeff_fmpz(poly, n, t)
+    fmpz_clear_readonly(t)
+
+cdef void fmpz_poly_get_coeff_mpz(mpz_t x, const fmpz_poly_t poly, slong n):
+    cdef fmpz_t t
+    fmpz_init(t)
+    fmpz_poly_get_coeff_fmpz(t, poly, n)
+    fmpz_get_mpz(x, t)
+    fmpz_clear(t)
+
+cdef void fmpz_poly_set_mpz(fmpz_poly_t poly, const mpz_t x):
+    fmpz_poly_fit_length(poly, 1)
+    fmpz_set_mpz(poly.coeffs, x)
+    _fmpz_poly_set_length(poly, 1)
+    _fmpz_poly_normalise(poly)
diff --git a/src/sage/libs/flint/fmpz_poly_q.pxd b/src/sage/libs/flint/fmpz_poly_q.pxd
index 846542dc0d8..63c13355bf6 100644
--- a/src/sage/libs/flint/fmpz_poly_q.pxd
+++ b/src/sage/libs/flint/fmpz_poly_q.pxd
@@ -49,11 +49,7 @@ cdef extern from "flint_wrap.h":
 
     #* Scalar multiplication and division ****************************************/
     void fmpz_poly_q_scalar_mul_si(fmpz_poly_q_t rop, const fmpz_poly_q_t op, long x)
-    void fmpz_poly_q_scalar_mul_mpz(fmpz_poly_q_t rop, const fmpz_poly_q_t op, const mpz_t x)
-    void fmpz_poly_q_scalar_mul_mpq(fmpz_poly_q_t rop, const fmpz_poly_q_t op, const mpq_t x)
     void fmpz_poly_q_scalar_div_si(fmpz_poly_q_t rop, const fmpz_poly_q_t op, long x)
-    void fmpz_poly_q_scalar_div_mpz(fmpz_poly_q_t rop, const fmpz_poly_q_t op, const mpz_t x)
-    void fmpz_poly_q_scalar_div_mpq(fmpz_poly_q_t rop, const fmpz_poly_q_t op, const mpq_t x)
 
     #* Multiplication and division ***********************************************/
     void fmpz_poly_q_mul(fmpz_poly_q_t rop, 
@@ -67,9 +63,6 @@ cdef extern from "flint_wrap.h":
     #* Derivative ****************************************************************/
     void fmpz_poly_q_derivative(fmpz_poly_q_t rop, const fmpz_poly_q_t op)
 
-    #* Evaluation ****************************************************************/
-    int fmpz_poly_q_evaluate(mpq_t rop, const fmpz_poly_q_t f, const mpq_t a)
-
     #* Input and output **********************************************************/
     int fmpz_poly_q_set_str(fmpz_poly_q_t rop, const char *s)
     char * fmpz_poly_q_get_str(const fmpz_poly_q_t op)
diff --git a/src/sage/libs/linbox/linbox_flint_interface.pyx b/src/sage/libs/linbox/linbox_flint_interface.pyx
index dabd375c2b8..3ca65afc514 100644
--- a/src/sage/libs/linbox/linbox_flint_interface.pyx
+++ b/src/sage/libs/linbox/linbox_flint_interface.pyx
@@ -33,6 +33,7 @@ and C. Pernet. The functions available are:
 #                  https://www.gnu.org/licenses/
 # ****************************************************************************
 
+from sage.libs.gmp.types cimport mpz_t
 from sage.libs.flint.types cimport fmpz_t
 from sage.libs.flint.fmpz cimport fmpz_get_mpz, fmpz_set_mpz
 from sage.libs.flint.fmpz_mat cimport fmpz_mat_entry, fmpz_mat_nrows, fmpz_mat_ncols
@@ -80,11 +81,13 @@ cdef void fmpz_poly_set_linbox(fmpz_poly_t p, PolynomialRing_integer.Element& q)
     (the .pxd file) in order to keep the header C-compatible
     """
     cdef size_t i
+    cdef mpz_t tmp
 
     fmpz_poly_fit_length(p, q.size())
 
     for i in range(q.size()):
-        fmpz_poly_set_coeff_mpz(p, i, q[i].get_mpz_const())
+        tmp = q[i].get_mpz_const()
+        fmpz_poly_set_coeff_mpz(p, i, tmp)
 
     _fmpz_poly_set_length(p, q.size())
 
diff --git a/src/sage/matrix/matrix_complex_ball_dense.pyx b/src/sage/matrix/matrix_complex_ball_dense.pyx
index 22366b5f1f2..7fdf3f2aa36 100644
--- a/src/sage/matrix/matrix_complex_ball_dense.pyx
+++ b/src/sage/matrix/matrix_complex_ball_dense.pyx
@@ -1,4 +1,4 @@
-# distutils: libraries = ARB_LIBRARY
+# distutils: libraries = flint
 r"""
 Arbitrary precision complex ball matrices using Arb
 
diff --git a/src/sage/matrix/matrix_integer_sparse.pyx b/src/sage/matrix/matrix_integer_sparse.pyx
index 0712500e67d..daba89d5c43 100644
--- a/src/sage/matrix/matrix_integer_sparse.pyx
+++ b/src/sage/matrix/matrix_integer_sparse.pyx
@@ -847,6 +847,7 @@ cdef class Matrix_integer_sparse(Matrix_sparse):
             sage: matrix(ZZ, 1, 1, sparse=True)._charpoly_linbox()
             x
         """
+        cdef mpz_t tmp
         if self._nrows != self._ncols:
             raise ArithmeticError('only valid for square matrix')
 
@@ -869,7 +870,8 @@ cdef class Matrix_integer_sparse(Matrix_sparse):
         cdef size_t i
         fmpz_poly_fit_length(g._poly, p.size())
         for i in range(p.size()):
-            fmpz_poly_set_coeff_mpz(g._poly, i, p[0][i].get_mpz_const())
+            tmp = p[0][i].get_mpz_const()
+            fmpz_poly_set_coeff_mpz(g._poly, i, tmp)
         _fmpz_poly_set_length(g._poly, p.size())
 
         del M
@@ -966,9 +968,11 @@ cdef class Matrix_integer_sparse(Matrix_sparse):
         sig_off()
 
         cdef size_t i
+        cdef mpz_t tmp
         fmpz_poly_fit_length(g._poly, p.size())
         for i in range(p.size()):
-            fmpz_poly_set_coeff_mpz(g._poly, i, p[0][i].get_mpz_const())
+            tmp = p[0][i].get_mpz_const()
+            fmpz_poly_set_coeff_mpz(g._poly, i, tmp)
         _fmpz_poly_set_length(g._poly, p.size())
 
         del M
diff --git a/src/sage/rings/polynomial/polynomial_rational_flint.pyx b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
index f651c9f3512..c68246d2142 100644
--- a/src/sage/rings/polynomial/polynomial_rational_flint.pyx
+++ b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
@@ -222,7 +222,7 @@ cdef class Polynomial_rational_flint(Polynomial):
         cdef unsigned long n
         cdef Rational c
         cdef list L1
-        cdef mpq_t * L2
+        cdef fmpq_t q
 
         Polynomial.__init__(self, parent, is_gen=is_gen)
 
@@ -253,14 +253,11 @@ cdef class Polynomial_rational_flint(Polynomial):
             L1 = [e if isinstance(e, Rational) else Rational(e) for e in x]
             n  = <unsigned long> len(x)
             sig_on()
-            L2 = <mpq_t *> check_allocarray(n, sizeof(mpq_t))
+            fmpq_poly_fit_length(self._poly, n)
             for deg from 0 <= deg < n:
-                mpq_init(L2[deg])
-                mpq_set(L2[deg], (<Rational> L1[deg]).value)
-            fmpq_poly_set_array_mpq(self._poly, L2, n)
-            for deg from 0 <= deg < n:
-                mpq_clear(L2[deg])
-            sig_free(L2)
+                fmpq_init_set_readonly(q, (<Rational> L1[deg]).value)
+                fmpq_poly_set_coeff_fmpq(self._poly, deg, q)
+                fmpq_clear_readonly(q)
             sig_off()
 
 #           deg = 0
@@ -435,6 +432,7 @@ cdef class Polynomial_rational_flint(Polynomial):
         utmost care.
         """
         cdef bint do_sig = _do_sig(self._poly)
+        cdef fmpz_t tmpfz
 
         if isinstance(value, int):
             if do_sig: sig_str("FLINT exception")
@@ -442,7 +440,9 @@ cdef class Polynomial_rational_flint(Polynomial):
             if do_sig: sig_off()
         elif isinstance(value, Integer):
             if do_sig: sig_str("FLINT exception")
-            fmpq_poly_set_coeff_mpz(self._poly, n, (<Integer> value).value)
+            fmpz_init_set_readonly(tmpfz, (<Integer> value).value)
+            fmpq_poly_set_coeff_fmpz(self._poly, n, tmpfz)
+            fmpz_clear_readonly(tmpfz)
             if do_sig: sig_off()
         elif isinstance(value, Rational):
             if do_sig: sig_str("FLINT exception")
@@ -492,7 +492,7 @@ cdef class Polynomial_rational_flint(Polynomial):
         cdef Polynomial_rational_flint f
         cdef Rational r
         cdef fmpz_t tmpfz
-        cdef fmpq_t tmpfq
+        cdef fmpq_t tmpfq, tmpfq1
         cdef RealBall arb_a, arb_z
         cdef ComplexBall acb_a, acb_z
 
@@ -508,13 +508,23 @@ cdef class Polynomial_rational_flint(Polynomial):
             elif isinstance(a, Rational):
                 r = Rational.__new__(Rational)
                 sig_str("FLINT exception")
-                fmpq_poly_evaluate_mpq(r.value, self._poly, (<Rational> a).value)
+                fmpq_init_set_readonly(tmpfq, (<Rational> a).value)
+                fmpq_init(tmpfq1)
+                fmpq_poly_evaluate_fmpq(tmpfq1, self._poly, tmpfq)
+                fmpq_get_mpq(r.value, tmpfq1)
+                fmpq_clear(tmpfq1)
+                fmpq_clear_readonly(tmpfq)
                 sig_off()
                 return r
             elif isinstance(a, Integer):
                 r = Rational.__new__(Rational)
                 sig_str("FLINT exception")
-                fmpq_poly_evaluate_mpz(r.value, self._poly, (<Integer> a).value)
+                fmpz_init_set_readonly(tmpfz, (<Integer> a).value)
+                fmpq_init(tmpfq)
+                fmpq_poly_evaluate_fmpz(tmpfq, self._poly, tmpfz)
+                fmpq_get_mpq(r.value, tmpfq)
+                fmpq_clear(tmpfq)
+                fmpz_clear_readonly(tmpfz)
                 sig_off()
                 return r
             elif isinstance(a, int):
@@ -1321,6 +1331,7 @@ cdef class Polynomial_rational_flint(Polynomial):
         """
         cdef Polynomial_rational_flint res
         cdef bint do_sig
+        cdef fmpq_t tmpfq
 
         if right == 0:
             raise ZeroDivisionError("division by zero polynomial")
@@ -1331,8 +1342,9 @@ cdef class Polynomial_rational_flint(Polynomial):
                 do_sig = _do_sig(self._poly)
 
                 if do_sig: sig_str("FLINT exception")
-                fmpq_poly_scalar_div_mpq(res._poly, self._poly,
-                                                  (<Rational> QQ(right)).value)
+                fmpq_init_set_readonly(tmpfq, (<Rational> QQ(right)).value)
+                fmpq_poly_scalar_div_fmpq(res._poly, self._poly, tmpfq)
+                fmpq_clear_readonly(tmpfq)
                 if do_sig: sig_off()
                 return res
 
diff --git a/src/sage/symbolic/ginac/inifcns_orthopoly.cpp b/src/sage/symbolic/ginac/inifcns_orthopoly.cpp
index a591cb4cd7c..a90f2050c59 100644
--- a/src/sage/symbolic/ginac/inifcns_orthopoly.cpp
+++ b/src/sage/symbolic/ginac/inifcns_orthopoly.cpp
@@ -20,6 +20,7 @@
 #include "utils.h"
 
 #include "gmp.h"
+#include "flint/fmpz_poly.h"
 #include "flint/fmpq_poly.h"
 #include "flint/fmpq.h"
 
@@ -63,7 +64,7 @@ static ex chebyt_eval(const ex& n_, const ex& x)
         for (int i = 0; i<len; ++i) {
                 mpz_t bigint;
                 mpz_init(bigint);
-                fmpz_poly_get_coeff_mpz(bigint, p, i);
+                fmpz_get_mpz(bigint, fmpz_poly_get_coeff_ptr(p, i));
                 numeric coeff(bigint);
                 if (not coeff.is_zero())
                         vec.emplace_back(currx, coeff);
@@ -122,7 +123,7 @@ static ex chebyu_eval(const ex& n_, const ex& x)
         for (int i = 0; i<len; ++i) {
                 mpz_t bigint;
                 mpz_init(bigint);
-                fmpz_poly_get_coeff_mpz(bigint, p, i);
+                fmpz_get_mpz(bigint, fmpz_poly_get_coeff_ptr(p, i));
                 numeric coeff(bigint);
                 if (not coeff.is_zero())
                         vec.emplace_back(currx, coeff);
diff --git a/src/sage/symbolic/ginac/useries.cpp b/src/sage/symbolic/ginac/useries.cpp
index 40fbd7ab360..b9a8b867648 100644
--- a/src/sage/symbolic/ginac/useries.cpp
+++ b/src/sage/symbolic/ginac/useries.cpp
@@ -467,10 +467,17 @@ void add::useries(flint_series_t& fp, int order) const
                 fmpq_poly_set_ui(fp.ft, 0);
         else if (oc.is_long())
                 fmpq_poly_set_si(fp.ft, oc.to_long());
-        else if (oc.is_mpz())
-                fmpq_poly_set_mpz(fp.ft, oc.as_mpz());
-        else
-                fmpq_poly_set_mpq(fp.ft, oc.as_mpq());
+        else if (oc.is_mpz()) {
+                fmpz_t tmpfz;
+                fmpz_init_set_readonly(tmpfz, oc.as_mpz());
+                fmpq_poly_set_fmpz(fp.ft, tmpfz);
+                fmpz_clear_readonly(tmpfz);
+        } else {
+                fmpq_t tmpfq;
+                fmpq_init_set_readonly(tmpfq, oc.as_mpq());
+                fmpq_poly_set_fmpq(fp.ft, tmpfq);
+                fmpq_clear_readonly(tmpfq);
+        }
 
         for (const auto & elem : seq) {
 		const ex& t = recombine_pair_to_ex(elem);
@@ -505,10 +512,17 @@ void mul::useries(flint_series_t& fp, int order) const
 
         if (oc.is_long())
                 fmpq_poly_scalar_mul_si(fp.ft, fp.ft, oc.to_long());
-        else if (oc.is_mpz())
-                fmpq_poly_scalar_mul_mpz(fp.ft, fp.ft, oc.as_mpz());
-        else
-                fmpq_poly_scalar_mul_mpq(fp.ft, fp.ft, oc.as_mpq());
+        else if (oc.is_mpz()) {
+                fmpz_t tmpfz;
+                fmpz_init_set_readonly(tmpfz, oc.as_mpz());
+                fmpq_poly_scalar_mul_fmpz(fp.ft, fp.ft, tmpfz);
+                fmpz_clear_readonly(tmpfz);
+        } else {
+                fmpq_t tmpfq;
+                fmpq_init_set_readonly(tmpfq, oc.as_mpq());
+                fmpq_poly_scalar_mul_fmpq(fp.ft, fp.ft, tmpfq);
+                fmpq_clear_readonly(tmpfq);
+        }
 }
 
 void power::useries(flint_series_t& fp, int order) const
@@ -563,7 +577,10 @@ void power::useries(flint_series_t& fp, int order) const
                 }
                 check_poly_ccoeff_one(fp1);
                 fmpq_poly_log_series(fp1.ft, fp1.ft, order);
-                fmpq_poly_scalar_mul_mpq(fp1.ft, fp1.ft, nexp.as_mpq());
+                fmpq_t tmp;
+                fmpq_init_set_readonly(tmp, nexp.as_mpq());
+                fmpq_poly_scalar_mul_fmpq(fp1.ft, fp1.ft, tmp);
+                fmpq_clear_readonly(tmp);
                 fmpq_poly_exp_series(fp.ft, fp1.ft, order);
                 return;
         }
@@ -608,10 +625,17 @@ void numeric::useries(flint_series_t& fp, int order) const
 {
         if (is_long())
                 fmpq_poly_set_si(fp.ft, to_long());
-        else if (is_mpz())
-                fmpq_poly_set_mpz(fp.ft, as_mpz());
-        else
-                fmpq_poly_set_mpq(fp.ft, as_mpq());
+        else if (is_mpz()) {
+                fmpz_t tmpfz;
+                fmpz_init_set_readonly(tmpfz, as_mpz());
+                fmpq_poly_set_fmpz(fp.ft, tmpfz);
+                fmpz_clear_readonly(tmpfz);
+        } else {
+                fmpq_t tmpfq;
+                fmpq_init_set_readonly(tmpfq, as_mpq());
+                fmpq_poly_set_fmpq(fp.ft, tmpfq);
+                fmpq_clear_readonly(tmpfq);
+        }
 }
 
 } // namespace GiNaC
diff --git a/src/sage_setup/library_order.py b/src/sage_setup/library_order.py
index f40690f8d22..9ae0d2579a7 100644
--- a/src/sage_setup/library_order.py
+++ b/src/sage_setup/library_order.py
@@ -16,17 +16,12 @@
 
 aliases = cython_aliases(required_modules=(), optional_modules=modules)
 
-if "ARB_LIBRARY" in aliases:
-    arb_dylib_names = [aliases["ARB_LIBRARY"]]
-else:
-    arb_dylib_names = []
-
 library_order_list = aliases.get("SINGULAR_LIBRARIES", []) + [
     "giac", "intl", "curl",
     "ec", "ecm"
 ] + aliases.get("LINBOX_LIBRARIES", []) + aliases.get("FFLASFFPACK_LIBRARIES", []) + aliases.get("GSL_LIBRARIES", []) + [
     "pari", "flint", "ecl", "glpk", "ppl",
-] + arb_dylib_names + [
+] + [
     "mpfi", "mpfr", "mpc", "ntl", "gmp", "gmpxx",
     "brial",
     "brial_groebner",

From 03713705146cbfcb391431eab3ca3b2f8322e1a4 Mon Sep 17 00:00:00 2001
From: Marc Mezzarobba <marc@mezzarobba.net>
Date: Tue, 4 Jul 2023 11:23:26 +0200
Subject: [PATCH 3/7] test that #20003 is fixed

---
 .../polynomial/polynomial_zmod_flint.pyx      |  5 +++
 .../con_rational_function_field.py            | 42 +++++--------------
 2 files changed, 15 insertions(+), 32 deletions(-)

diff --git a/src/sage/rings/polynomial/polynomial_zmod_flint.pyx b/src/sage/rings/polynomial/polynomial_zmod_flint.pyx
index 6e7f7498329..3a66198d568 100644
--- a/src/sage/rings/polynomial/polynomial_zmod_flint.pyx
+++ b/src/sage/rings/polynomial/polynomial_zmod_flint.pyx
@@ -658,6 +658,11 @@ cdef class Polynomial_zmod_flint(Polynomial_template):
             ...
             NotImplementedError: square free factorization of polynomials over rings with composite characteristic is not implemented
 
+        :trac:`20003`::
+
+            sage: P.<x> = GF(7)[]
+            sage: (6*x+3).squarefree_decomposition()
+            (6) * (x + 4)
         """
         if not self.base_ring().is_field():
             raise NotImplementedError("square free factorization of polynomials over rings with composite characteristic is not implemented")
diff --git a/src/sage/schemes/plane_conics/con_rational_function_field.py b/src/sage/schemes/plane_conics/con_rational_function_field.py
index 05d24e78a85..581102b5c5b 100644
--- a/src/sage/schemes/plane_conics/con_rational_function_field.py
+++ b/src/sage/schemes/plane_conics/con_rational_function_field.py
@@ -198,38 +198,6 @@ def has_rational_point(self, point=False, algorithm='default',
             Fraction Field of Univariate Polynomial Ring in u over Rational
             Field with modulus v^2 - u^3 - 1
 
-        ``has_rational_point`` fails for some conics over function fields
-        over finite fields, due to :trac:`20003`::
-
-            sage: K.<t> = PolynomialRing(GF(7))
-            sage: C = Conic([5*t^2 + 4, t^2 + 3*t + 3, 6*t^2 + 3*t + 2,
-            ....:            5*t^2 + 5, 4*t + 3, 4*t^2 + t + 5])
-            sage: C.has_rational_point()                                                # needs sage.libs.singular
-            Traceback (most recent call last):
-            ...
-            TypeError: self (=Scheme morphism:
-              From: Projective Conic Curve over Fraction Field of Univariate
-                    Polynomial Ring in t over Finite Field of size 7 defined by
-                    (-2*t^2 - 3)*x^2 + (-t^3 + 3*t^2 - 2*t - 2)/(t + 3)*y^2 + (-t^6 + 3*t^5 + t^3 - t^2 - t + 2)/(t^4 + t^3 - 3*t^2 + 3*t + 1)*z^2
-              To:   Projective Conic Curve over Fraction Field of Univariate
-                    Polynomial Ring in t over Finite Field of size 7 defined by
-                    (-2*t^2 - 3)*x^2 + (t^2 + 3*t + 3)*x*y + (-2*t^2 - 2)*y^2 + (-t^2 + 3*t + 2)*x*z + (-3*t + 3)*y*z + (-3*t^2 + t - 2)*z^2
-              Defn: Defined on coordinates by sending (x : y : z) to
-                    (x + (2*t - 2)/(t + 3)*y + (3*t^4 + 2*t^3 - 2*t^2 - 2*t + 3)/(t^4 + t^3 - 3*t^2 + 3*t + 1)*z
-                     : y + (-t^3 - t^2 + 3*t - 1)/(t^3 - 3*t^2 + 2*t + 2)*z : z))
-            domain must equal right (=Scheme morphism:
-              From: Projective Conic Curve over Fraction Field of Univariate
-                    Polynomial Ring in t over Finite Field of size 7 defined by
-                    (-2*t^3 - t^2 + 3*t + 3)*x^2 + (t - 3)*y^2 + (-t^7 + 2*t^5 + t^4 + 2*t^3 + 3*t^2 - t - 1)*z^2
-              To:   Projective Conic Curve over Fraction Field of Univariate
-                    Polynomial Ring in t over Finite Field of size 7 defined by
-                    -2/(t^3 - 3*t^2 + 2*t + 2)*x^2 + 1/(t^3 + 3*t^2 - 2*t + 1)*y^2 + (-t^6 + 3*t^5 + t^3 - t^2 - t + 2)/(t^9 - 2*t^8 + t^7 - t^6 + 3*t^5 - 3*t^3 + t^2 - 2*t + 3)*z^2
-              Defn: Defined on coordinates by sending (x : y : z) to
-                    ((t^3 - 3*t^2 + 2*t + 2)*x : (t^2 - 2)*y : (t^5 - 3*t^4 + t^2 + 3*t + 3)*z))
-            codomain
-
-
-
         TESTS::
 
             sage: K.<t> = FractionField(PolynomialRing(QQ, 't'))
@@ -250,6 +218,16 @@ def has_rational_point(self, point=False, algorithm='default',
             sage: C.has_rational_point(point=True)  # long time (4 seconds)             # needs sage.libs.singular
             (True,
              ((-2/117*t^8 + 304/1053*t^7 + 40/117*t^6 - 1/27*t^5 - 110/351*t^4 - 2/195*t^3 + 11/351*t^2 + 1/117)/(t^4 + 2/39*t^3 + 4/117*t^2 + 2/39*t + 14/39) : -5/3*t^4 + 19*t^3 : 1))
+
+        ``has_rational_point`` used to fail for some conics over function fields
+        over finite fields, due to :trac:`20003`::
+
+            sage: K.<t> = PolynomialRing(GF(7))
+            sage: C = Conic([5*t^2 + 4, t^2 + 3*t + 3, 6*t^2 + 3*t + 2,
+            ....:            5*t^2 + 5, 4*t + 3, 4*t^2 + t + 5])
+            sage: C.has_rational_point()
+            True
+
         """
         from .constructor import Conic
 

diff --git a/src/sage/libs/arb/acb.pxd b/src/sage/libs/arb/acb.pxd
index 3f53b96d331..851488d803a 100644
--- a/src/sage/libs/arb/acb.pxd
+++ b/src/sage/libs/arb/acb.pxd
@@ -152,10 +152,6 @@ cdef extern from "arb_wrap.h":
     void acb_sech(acb_t s, const acb_t z, long prec)
     void acb_csch(acb_t c, const acb_t z, long prec)
 
-    void acb_rising_ui_bs(acb_t z, const acb_t x, unsigned long n, long prec)
-    void acb_rising_ui_rs(acb_t z, const acb_t x, unsigned long n, unsigned long step, long prec)
-    void acb_rising_ui_rec(acb_t z, const acb_t x, unsigned long n, long prec)
-    void acb_rising_ui(acb_t z, const acb_t x, unsigned long n, long prec)
     void acb_rising(acb_t z, const acb_t x, const acb_t n, long prec)
 
     void acb_gamma(acb_t y, const acb_t x, long prec)
diff --git a/src/sage/libs/arb/arb.pxd b/src/sage/libs/arb/arb.pxd
index 33083fc125f..acd232ab816 100644
--- a/src/sage/libs/arb/arb.pxd
+++ b/src/sage/libs/arb/arb.pxd
@@ -224,15 +224,8 @@ cdef extern from "arb_wrap.h":
 
     void arb_lambertw(arb_t res, const arb_t x, int flags, long prec)
 
-    void arb_rising_ui_bs(arb_t z, const arb_t x, unsigned long n, long prec)
-    void arb_rising_ui_rs(arb_t z, const arb_t x, unsigned long n, unsigned long step, long prec)
-    void arb_rising_ui_rec(arb_t z, const arb_t x, unsigned long n, long prec)
-    void arb_rising_ui(arb_t z, const arb_t x, unsigned long n, long prec)
     void arb_rising(arb_t z, const arb_t x, const arb_t n, long prec)
     void arb_rising_fmpq_ui(arb_t z, const fmpq_t x, unsigned long n, long prec)
-    void arb_rising2_ui_bs(arb_t u, arb_t v, const arb_t x, unsigned long n, long prec)
-    void arb_rising2_ui_rs(arb_t u, arb_t v, const arb_t x, unsigned long n, unsigned long step, long prec)
-    void arb_rising2_ui(arb_t u, arb_t v, const arb_t x, unsigned long n, long prec)
     void arb_fac_ui(arb_t z, unsigned long n, long prec)
     void arb_bin_ui(arb_t z, const arb_t n, unsigned long k, long prec)
     void arb_bin_uiui(arb_t z, unsigned long n, unsigned long k, long prec)

From 8df55377938a6576baf0aacab3046932615d652b Mon Sep 17 00:00:00 2001
From: Marc Mezzarobba <marc@mezzarobba.net>
Date: Sun, 15 Oct 2023 12:55:50 +0200
Subject: [PATCH 6/7] update tests for flint3

---
 src/sage/rings/complex_arb.pyx | 7 ++++---
 src/sage/rings/real_arb.pyx    | 4 ++--
 2 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/src/sage/rings/complex_arb.pyx b/src/sage/rings/complex_arb.pyx
index f36a89bb229..20a06f7eaa3 100644
--- a/src/sage/rings/complex_arb.pyx
+++ b/src/sage/rings/complex_arb.pyx
@@ -1360,12 +1360,13 @@ cdef class ComplexBall(RingElement):
             sage: CBF100(-3r)
             -3.000000000000000000000000000000
 
-            sage: ComplexBall(CBF100, 10^100)
-            1.000000000000000000000000000000e+100
             sage: ComplexBall(CBF100, CIF(1, 2))
             1.000000000000000000000000000000 + 2.000000000000000000000000000000*I
             sage: ComplexBall(CBF100, RBF(1/3), RBF(1))
             [0.3333333333333333 +/- ...e-17] + 1.000000000000000000000000000000*I
+            sage: ComplexBall(CBF100, 10^100)
+            [1.000000000000000000000000000000e+100 +/- ...]
+
             sage: NF.<a> = QuadraticField(-1, embedding=CC(0, -1))
             sage: CBF(a)
             -1.000000000000000*I
@@ -3009,7 +3010,7 @@ cdef class ComplexBall(RingElement):
             sage: CBF(1).rising_factorial(2**64)
             [+/- ...e+347382171326740403407]
             sage: ComplexBallField(128)(1).rising_factorial(2**64)
-            [2.343691126796861348e+347382171305201285713 +/- ...e+347382171305201285694]
+            [2.34369112679686134...e+347382171305201285713 +/- ...]
             sage: CBF(1/2).rising_factorial(CBF(2,3)) # abs tol 1e-15
             [-0.123060451458124 +/- 3.06e-16] + [0.0406412631676552 +/- 7.57e-17]*I
 
diff --git a/src/sage/rings/real_arb.pyx b/src/sage/rings/real_arb.pyx
index a9ce06d14ca..affe11e4376 100644
--- a/src/sage/rings/real_arb.pyx
+++ b/src/sage/rings/real_arb.pyx
@@ -898,7 +898,7 @@ class RealBallField(UniqueRepresentation, sage.rings.abc.RealBallField):
             sage: RBF.gamma(5)
             24.00000000000000
             sage: RBF.gamma(10**20)
-            [+/- ...e+1956570552410610660600]
+            [1.932849514310098...+1956570551809674817225 +/- ...]
             sage: RBF.gamma(1/3)
             [2.678938534707747 +/- ...e-16]
             sage: RBF.gamma(-5)
@@ -1102,7 +1102,7 @@ class RealBallField(UniqueRepresentation, sage.rings.abc.RealBallField):
              15.00000000000000,
              48.00000000000000]
             sage: RBF.double_factorial(2**20)
-            [1.4483729903e+2928836 +/- ...e+2928825]
+            [1.448372990...e+2928836 +/- ...]
             sage: RBF.double_factorial(2**1000)
             Traceback (most recent call last):
             ...

From ec33fc9e2076bb4a9f94c70dfdc24b90cd3de183 Mon Sep 17 00:00:00 2001
From: Marc Mezzarobba <marc@mezzarobba.net>
Date: Sun, 22 Oct 2023 09:53:06 +0200
Subject: [PATCH 7/7] missing includes
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

(thanks to Gonzalo Tornaría)
---
 src/sage/libs/arb/arb_wrap.h     | 2 ++
 src/sage/libs/flint/flint_wrap.h | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/src/sage/libs/arb/arb_wrap.h b/src/sage/libs/arb/arb_wrap.h
index f51c89ffe38..488bb376d5e 100644
--- a/src/sage/libs/arb/arb_wrap.h
+++ b/src/sage/libs/arb/arb_wrap.h
@@ -5,6 +5,8 @@
  * by arb, most of which rely on flint's ulong and slong defines.
  */
 
+#include <mpfr.h>
+
 #undef ulong
 #undef slong
 
diff --git a/src/sage/libs/flint/flint_wrap.h b/src/sage/libs/flint/flint_wrap.h
index a416d5b53db..4db72b97660 100644
--- a/src/sage/libs/flint/flint_wrap.h
+++ b/src/sage/libs/flint/flint_wrap.h
@@ -15,6 +15,7 @@
  */
 
 #include <gmp.h>
+#include <mpfr.h>
 
 /* Save previous definition of ulong if any, as pari also uses it */
 /* Should work on GCC, clang, MSVC */
@@ -33,6 +34,7 @@
 
 #include <flint/arith.h>
 #include <flint/fmpq.h>
+#include <flint/fmpq_vec.h>
 #include <flint/fmpq_mat.h>
 #include <flint/fmpq_poly.h>
 #include <flint/fmpz.h>
