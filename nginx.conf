# Example nginx configuration file
# Edited from https://ubuntu.self-hosted.fr/installation-piwigo-nginx-mariadb/

server {
    listen 80;
    listen [::]:80;
    server_name piwigo.domain.tld;  # TODO: edit-me

    # Enforce HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443      ssl http2;
    listen [::]:443 ssl http2;
    server_name     piwigo.domain.tld;  # TODO: edit-me
    # TODO: generate certificate
    ssl_certificate     /path/to/fullchain.pem;
    ssl_certificate_key /path/to/privkey.pem;
    include snippets/ssl.conf;
    include snippets/hsts.conf;

    # Path to the root of your installation
    root                          /usr/share/webapps/piwigo/;

    # Add headers to serve security related headers
    add_header                    X-Frame-Options "SAMEORIGIN";
    add_header                    X-Content-Type-Options nosniff;
    add_header                    X-XSS-Protection "1; mode=block";
    add_header                    X-Robots-Tag none;
    add_header                    X-Download-Options noopen;
    add_header                    X-Permitted-Cross-Domain-Policies none;
    add_header                    Strict-Transport-Security 'max-age=31536000; includeSubDomains;';
    add_header                    Referrer-Policy no-referrer always;

    # set max upload size
    client_max_body_size          512M;
    fastcgi_buffers               64 4K;

    # Enable gzip but do not remove ETag headers
    gzip                          on;
    gzip_vary                     on;
    gzip_comp_level               4;
    gzip_min_length               256;
    gzip_proxied                  expired no-cache no-store private no_last_modified no_etag auth;
    gzip_types                    application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

    location / {
        index                     index.php;
        try_files                 $uri $uri/ @rewrite =404;
    }

    location @rewrite {
        rewrite                   ^/picture((/|$).*)$ /picture.php$1 last;
        rewrite                   ^/index((/|$).*)$ /index.php$1 last;
        rewrite                   ^/i((/|$).*)$ /i.php$1 last;
    }

    location ~ ^(?<script_name>.+?\.php)(?<path_info>/.*)?$ {
        try_files                 $script_name =404;
        include                   /etc/nginx/fastcgi_params;
        fastcgi_pass              unix:/run/php-fpm/piwigo.sock;
        fastcgi_param             PATH_INFO $path_info;
        fastcgi_param             SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location ~ ^/favicon.ico$ {
        log_not_found             off;
        access_log                off;
        expires                   max;
    }

    location = /robots.txt {
        allow                     all;
        log_not_found             off;
        access_log                off;
    }

    # piwigo distribution files
    location ~ ^/(README|doc)$ {
        deny                      all;
    }

    # prevent direct acces to uploaded images, derivates and logs
    location ~ ^/(_data/logs|upload)/ {
        deny                      all;
    }

    # prevent any hotlinks and direct access to alias URIs (/i/upload/...)
    # which are not from Piwigo itself (happens when exporting from lightroom via ws.php)
    set                           $check_referal "";

    # very restrictive
    valid_referers                *.domain.tld;  # TODO: edit-me
    # if you want google etc to be able to show your images:
    #valid_referers ~google\.com ~bing\.com *.domain.tld

    if ($invalid_referer) {
        set                       $check_referal "invalid";
    }
    if ($http_user_agent !~ "Piwigo") {
        set                       $check_referal "${check_referal}+not_piwigo";
    }
}
