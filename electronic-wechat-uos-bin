#!/bin/bash

function main(){
    if [[ $@ =~ '-xwayland' ]]; then
        x11Launch
    fi
    if [[ ${XDG_SESSION_DESKTOP} = KDE ]] && [[ ${XDG_SESSION_TYPE} = wayland ]]; then
        probeKwinVersion "$@"
    else
        x11Launch "$@"
    fi
}

function launch(){
	bwrap \
	--symlink usr/lib /lib \
	--symlink usr/lib64 /lib64 \
	--symlink usr/bin /bin \
	--symlink usr/bin /sbin \
	--ro-bind /opt /opt \
	--ro-bind /opt/electronic-wechat-uos-bin/os-release /etc/os-release \
	--ro-bind /opt/electronic-wechat-uos-bin/lsb-release /etc/lsb-release \
	--ro-bind /etc /etc \
	--ro-bind /usr /usr \
	--dev /dev \
	--dev-bind /dev/dri /dev/dri \
	--proc /proc \
	--ro-bind /sys/dev/char /sys/dev/char \
	--ro-bind /sys/devices /sys/devices \
	--ro-bind /run/dbus /run/dbus \
	--bind "$XDG_RUNTIME_DIR" "$XDG_RUNTIME_DIR" \
	--bind /tmp /tmp \
	--bind "$HOME" "$HOME" \
	--bind "$XDG_RUNTIME_DIR" "$XDG_RUNTIME_DIR" \
	env GTK_USE_PORTAL=1 /usr/lib/electron/electron /opt/electronic-wechat-uos-bin/resources/app.asar "$@"
}

function x11Launch(){
    note '使用 XWayland / X11...'
    launch --ignore-gpu-blocklist --enable-gpu-rasterization --enable-zero-copy --enable-features=VaapiVideoDecoder,VaapiIgnoreDriverChecks "$@" "${flagsIn}"
}

function probeKwinVersion(){
    _kwinVersion=`kwin_wayland --version | cut -c 6- | cut -c -4`
    if [[ `echo "${_kwinVersion} > 5.27" | bc` = 1 ]]; then
        waylandLaunch "$@"
    elif [[ ${_kwinVersion} = '5.27' ]]; then
        waylandLaunch "$@"
    else
        x11Launch "$@"
    fi
}

function waylandLaunch(){
    note '使用 Wayland...'
    note '在 KDE 系统设置中将虚拟键盘设置为 Fcitx5'
    _electronVer=`electron --version | cut -c 2-`

    if [[ `echo "${_electronVer} > 20" | bc` = 1 ]]; then
        waylandFlag="--ozone-platform-hint=auto"
    else
        waylandFlag="--ozone-platform=wayland"
    fi
    launch ${waylandFlag} --ignore-gpu-blocklist --enable-gpu-rasterization --enable-zero-copy --enable-wayland-ime --disable-gpu-driver-bug-workarounds --enable-features=VaapiVideoDecoder,VaapiIgnoreDriverChecks --disable-features=UseChromeOSDirectVideoDecoder "$@" "${flagsIn}"
}

function note() {
	if [ -f /usr/bin/pamac ]; then
		echo "  ==> [Info]: $@"
	else
        all_off="$(tput sgr0)"
        bold="${all_off}$(tput bold)"
        blue="${bold}$(tput setaf 4)"
        yellow="${bold}$(tput setaf 3)"
        printf "${blue}==>${yellow} [Info]:${bold} $1${all_off}\n"
    fi
}

flagsIn="$@"

main
