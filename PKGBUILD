# Author: Janusz Lewandowski <lew21@xtreeme.org>
# Maintainer: David McFarland <corngood@gmail.com>
# Autogenerated from AMD's Packages file

pkgbase=amdgpu-pro-installer
pkgname=(amdgpu-pro amdgpu-pro-dkms amdgpu-pro-gst-omx amdgpu-pro-libdrm amdgpu-pro-libgl amdgpu-pro-mesa-omx amdgpu-pro-opencl amdgpu-pro-vdpau amdgpu-pro-vulkan lib32-amdgpu-pro lib32-amdgpu-pro-gst-omx lib32-amdgpu-pro-libdrm lib32-amdgpu-pro-libgl lib32-amdgpu-pro-mesa-omx lib32-amdgpu-pro-opencl lib32-amdgpu-pro-vdpau lib32-amdgpu-pro-vulkan xf86-video-amdgpu-pro)
pkgver=17.40.492261
pkgrel=1
arch=('x86_64')
url='http://www.amd.com'
license=('custom:AMD')
makedepends=('wget')

DLAGENTS='https::/usr/bin/wget --referer https://support.amd.com/en-us/kb-articles/Pages/AMDGPU-PRO-Install.aspx -N %u'

source=(https://www2.ati.com/drivers/linux/ubuntu/amdgpu-pro-17.40-492261.tar.xz
	0001-disable-firmware-copy.patch
	0003-add-archlinux-as-build-option.patch)
sha256sums=(b0645157577c9ff175dc02487c4c682ded2624c8c2cfd6aa603960962e1d07b0
	85359c89d7f1317cf5176bc9c489314aba2db20d962b120a43fc532575466345
	2bf8eac2afac3bce0d17f840c15009838b578a72412ff66df6e8caa6c00fade7)



# extracts a debian package
# $1: deb file to extract
extract_deb() {
	local tmpdir="$(basename "${1%.deb}")"
	rm -Rf "$tmpdir"
	mkdir "$tmpdir"
	cd "$tmpdir"
	ar x "$1"
	tar -C "${pkgdir}" -xf data.tar.xz
}
# move ubuntu specific /usr/lib/x86_64-linux-gnu to /usr/lib
# $1: library dir
# $2: destination (optional)
move_libdir() {
	local libdir="usr/lib"
	if [ -n "$2" ]; then
		libdir="$2"
	fi
	if [ -d "$1" ]; then
		if [ -d "${pkgdir}/${libdir}" ]; then
			cp -ar -t "${pkgdir}/${libdir}/" "$1"/*
			rm -rf "$1"
		else
			mkdir -p "${pkgdir}/${libdir}"
			mv -t "${pkgdir}/${libdir}/" "$1"/*
			rmdir "$1"
		fi
	fi
}


package_amdgpu-pro () {
	pkgdesc="The AMDGPU Pro driver package"
	install=amdgpu-pro-core.install
	arch=('x86_64')
	depends=('binfmt-support' 'libedit>=2.11-20080614' 'libffi>=3.0.9' 'libx11' 'libxext' 'libxfixes' 'ncurses' 'ncurses5-compat-libs>=6' 'zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./amdgpu-pro-core_17.40-492261_all.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./amdgpu-pro-lib32_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./ids-amdgpu-pro_1.0.0-492261_all.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgbm1-amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgbm1-amdgpu-pro-base_17.40-492261_all.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgbm1-amdgpu-pro-dev_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-dri_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libllvm5.0-amdgpu-pro_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0-dev_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0-doc_5.0-492261_all.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0-runtime_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-dev_5.0-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-runtime_5.0-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

	# extra_commands:
	mv "${pkgdir}"/usr/lib/x86_64-linux-gnu/dri ${pkgdir}/usr/lib/
	# This is needed because libglx.so has a hardcoded DRI_DRIVER_PATH
	ln -s /usr/lib/dri ${pkgdir}/usr/lib/x86_64-linux-gnu/dri
	mkdir -p "${pkgdir}/etc/ld.so.conf.d/"
	echo "/opt/amdgpu-pro/lib/x86_64-linux-gnu/" > "${pkgdir}"/etc/ld.so.conf.d/amdgpu-pro.conf
}


package_amdgpu-pro-dkms () {
	pkgdesc="amdgpu-pro driver in DKMS format."
	arch=('any')
	depends=('amdgpu-pro=17.40.492261-1' 'dkms>=1.95')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./amdgpu-pro-dkms_17.40-492261_all.deb

	move_libdir "${pkgdir}/lib"

	# extra_commands:
	msg 'Applying patches...'
	(cd ${pkgdir}/usr/src/amdgpu-17.40-492261;
		sed -i 's/\/extra/\/extramodules/' dkms.conf
			msg2 '0001-disable-firmware-copy.patch'
		patch -p1 -i "${srcdir}/0001-disable-firmware-copy.patch";
		msg2 '0003-add-archlinux-as-build-option.patch'
		patch -p1 -i "${srcdir}/0003-add-archlinux-as-build-option.patch"
	)
}


package_amdgpu-pro-gst-omx () {
	pkgdesc="GStreamer OpenMAX plugins for AMDGPU Pro"
	arch=('x86_64')
	depends=('glib2>=2.37.3' 'gst-plugins-base>=1.6.0' 'gstreamer>=1.0.0' 'libomxil-bellagio')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./gst-omx-amdgpu-pro_1.0.0.1-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}


package_amdgpu-pro-libdrm () {
	pkgdesc="The AMDGPU Pro userspace interface to kernel DRM services"
	arch=('x86_64')
	provides=('libdrm')
	conflicts=('libdrm')
	depends=('amdgpu-pro=17.40.492261-1' 'bcunit')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-amdgpu1_2.4.82-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-dev_2.4.82-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-radeon1_2.4.82-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-utils_2.4.82-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm2-amdgpu-pro_2.4.82-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}


package_amdgpu-pro-libgl () {
	pkgdesc="The AMDGPU Pro libgl library symlinks"
	arch=('x86_64')
	provides=('libgl')
	conflicts=('libgl')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'libx11' 'libx11>=1.4.99.1' 'libxcb' 'libxcb>=1.8' 'libxcb>=1.9.2' 'libxdamage>=1.1' 'libxext' 'libxfixes' 'libxshmfence' 'libxxf86vm')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libegl1-amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-appprofiles_17.40-492261_all.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-ext_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-glx_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgles2-amdgpu-pro_17.40-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}


package_amdgpu-pro-mesa-omx () {
	pkgdesc="Mesa OpenMAX video drivers for AMDGPU Pro"
	arch=('x86_64')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'libomxil-bellagio' 'libx11' 'libxcb' 'libxcb>=1.8' 'ncurses5-compat-libs>=6' 'zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./mesa-amdgpu-pro-omx-drivers_17.0.1-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}


package_amdgpu-pro-opencl () {
	pkgdesc="The AMDGPU Pro OpenCL implementation"
	arch=('x86_64')
	provides=('opencl-driver')
	depends=('amdgpu-pro=17.40.492261-1' 'pciutils>=3.3.1-1')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./clinfo-amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./hsa-ext-amdgpu-pro-finalize_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./hsa-ext-amdgpu-pro-image_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./hsa-runtime-tools-amdgpu-pro_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./hsa-runtime-tools-amdgpu-pro-dev_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libopencl1-amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./opencl-amdgpu-pro-icd_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocm-amdgpu-pro_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocm-amdgpu-pro-icd_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocm-amdgpu-pro-opencl_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocm-amdgpu-pro-opencl-dev_17.40-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocr-amdgpu-pro_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./rocr-amdgpu-pro-dev_1.1.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./roct-amdgpu-pro_1.0.6-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./roct-amdgpu-pro-dev_1.0.6-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}


package_amdgpu-pro-vdpau () {
	pkgdesc="The AMDGPU Pro VDPAU driver"
	arch=('x86_64')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'libvdpau>=1.1' 'libxcb' 'libxcb>=1.8' 'ncurses5-compat-libs>=6' 'zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libvdpau-amdgpu-pro_17.0.1-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

	# extra_commands:
	mkdir -p "${pkgdir}"/usr/lib/
	ln -s /opt/amdgpu-pro/lib/x86_64-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib/libvdpau_amdgpu.so.1.0.0
	ln -s /opt/amdgpu-pro/lib/x86_64-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib/libvdpau_amdgpu.so.1
	ln -s /opt/amdgpu-pro/lib/x86_64-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib/libvdpau_amdgpu.so
}


package_amdgpu-pro-vulkan () {
	pkgdesc="The AMDGPU Pro Vulkan driver"
	arch=('x86_64')
	provides=('vulkan-driver')
	depends=('amdgpu-pro=17.40.492261-1')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./vulkan-amdgpu-pro_17.40-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

	# extra_commands:
	mkdir -p "${pkgdir}"/usr/share/vulkan/icd.d/
	mv "${pkgdir}"/etc/vulkan/icd.d/amd_icd64.json "${pkgdir}"/usr/share/vulkan/icd.d/
	sed -i "s@abi_versions\(.*\)0.9.0\(.*\)@api_version\11.0.61\2@" "${pkgdir}"/usr/share/vulkan/icd.d/amd_icd64.json
	rm -rf "${pkgdir}"/etc/vulkan/
}


package_lib32-amdgpu-pro () {
	pkgdesc="Meta package to install amdgpu Pro components. (32bit libraries)"
	arch=('x86_64')
	depends=('binfmt-support' 'lib32-libedit>=2.11-20080614' 'lib32-libffi>=3.0.9' 'lib32-libx11' 'lib32-libxext' 'lib32-libxfixes' 'lib32-ncurses' 'lib32-ncurses5-compat-libs>=6' 'lib32-zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./amdgpu-pro_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgbm1-amdgpu-pro_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgbm1-amdgpu-pro-dev_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-dri_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libllvm5.0-amdgpu-pro_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0-dev_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-5.0-runtime_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-dev_5.0-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./llvm-amdgpu-pro-runtime_5.0-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"

	# extra_commands:
	mkdir -p "${pkgdir}"/usr/lib32/
	mv "${pkgdir}"/usr/lib/i386-linux-gnu/dri "${pkgdir}"/usr/lib32/
	rm -rf "${pkgdir}"/etc
	mkdir -p "${pkgdir}/etc/ld.so.conf.d/"
	echo "/opt/amdgpu-pro/lib/i386-linux-gnu/" > "${pkgdir}"/etc/ld.so.conf.d/lib32-amdgpu-pro.conf

	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-gst-omx () {
	pkgdesc="GStreamer OpenMAX plugins for AMDGPU Pro (32bit libraries)"
	arch=('x86_64')
	depends=('lib32-glib2>=2.37.3' 'lib32-gst-plugins-base>=1.6.0' 'lib32-gstreamer>=1.0.0' 'lib32-libomxil-bellagio')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./gst-omx-amdgpu-pro_1.0.0.1-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"


	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-libdrm () {
	pkgdesc="The AMDGPU Pro userspace interface to kernel DRM services (32bit libraries)"
	arch=('x86_64')
	provides=('lib32-libdrm')
	conflicts=('lib32-libdrm')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-amdgpu1_2.4.82-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-dev_2.4.82-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm-amdgpu-pro-radeon1_2.4.82-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libdrm2-amdgpu-pro_2.4.82-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"


	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-libgl () {
	pkgdesc="The AMDGPU Pro libgl library symlinks (32bit libraries)"
	arch=('x86_64')
	provides=('lib32-libgl')
	conflicts=('lib32-libgl')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro-libgl=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'lib32-libx11' 'lib32-libx11>=1.4.99.1' 'lib32-libxcb' 'lib32-libxcb>=1.8' 'lib32-libxcb>=1.9.2' 'lib32-libxdamage>=1.1' 'lib32-libxext' 'lib32-libxfixes' 'lib32-libxshmfence' 'lib32-libxxf86vm')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libegl1-amdgpu-pro_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-ext_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgl1-amdgpu-pro-glx_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libgles2-amdgpu-pro_17.40-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"

	# extra_commands:
	rm -rf "${pkgdir}"/etc

	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-mesa-omx () {
	pkgdesc="Mesa OpenMAX video drivers for AMDGPU Pro (32bit libraries)"
	arch=('x86_64')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'lib32-libomxil-bellagio' 'lib32-libx11' 'lib32-libxcb' 'lib32-libxcb>=1.8' 'lib32-ncurses5-compat-libs>=6' 'lib32-zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./mesa-amdgpu-pro-omx-drivers_17.0.1-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"

	# extra_commands:
	rm -f "${pkgdir}"/etc/xdg/gstomx.conf

	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-opencl () {
	pkgdesc="The AMDGPU Pro OpenCL implementation"
	arch=('x86_64')
	provides=('lib32-opencl-driver')
	depends=('amdgpu-pro=17.40.492261-1')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libopencl1-amdgpu-pro_17.40-492261_i386.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./opencl-amdgpu-pro-icd_17.40-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"


	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-vdpau () {
	pkgdesc="The AMDGPU Pro VDPAU driver (32bit libraries)"
	arch=('x86_64')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'lib32-libvdpau>=1.1' 'lib32-libxcb' 'lib32-libxcb>=1.8' 'lib32-ncurses5-compat-libs>=6' 'lib32-zlib>=1.2.0')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./libvdpau-amdgpu-pro_17.0.1-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"

	# extra_commands:
	mkdir -p "${pkgdir}"/usr/lib32/
	ln -s /opt/amdgpu-pro/lib/i386-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib32/libvdpau_amdgpu.so.1.0.0
	ln -s /opt/amdgpu-pro/lib/i386-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib32/libvdpau_amdgpu.so.1
	ln -s /opt/amdgpu-pro/lib/i386-linux-gnu/vdpau/libvdpau_amdgpu.so.1.0.0 "${pkgdir}"/usr/lib32/libvdpau_amdgpu.so

	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_lib32-amdgpu-pro-vulkan () {
	pkgdesc="The AMDGPU Pro Vulkan driver (32bit libraries)"
	arch=('x86_64')
	provides=('lib32-vulkan-driver')
	depends=('amdgpu-pro=17.40.492261-1')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./vulkan-amdgpu-pro_17.40-492261_i386.deb

	move_libdir "${pkgdir}/lib" "usr/lib32"

	# extra_commands:
	mkdir -p "${pkgdir}"/usr/share/vulkan/icd.d/
	mv "${pkgdir}"/etc/vulkan/icd.d/amd_icd32.json "${pkgdir}"/usr/share/vulkan/icd.d/
	sed -i "s@abi_versions\(.*\)0.9.0\(.*\)@api_version\11.0.61\2@" "${pkgdir}"/usr/share/vulkan/icd.d/amd_icd32.json
	rm -rf "${pkgdir}"/etc/vulkan/

	# lib32 cleanup
	rm -rf "${pkgdir}"/usr/{bin,lib,include,share} "${pkgdir}/var" "${pkgdir}"/opt/amdgpu-pro/{bin,include,share}
	rm -rf "${pkgdir}"/opt/amdgpu-pro/lib/xorg/modules/extensions/

}


package_xf86-video-amdgpu-pro () {
	pkgdesc="The AMDGPU Pro X.org video driver"
	arch=('x86_64')
	provides=('xf86-video-amdgpu')
	conflicts=('xf86-video-amdgpu' 'xorg-server<1.19.0' 'X-ABI-VIDEODRV_VERSION<23' 'X-ABI-VIDEODRV_VERSION>=24')
	groups=('xorg-drivers')
	depends=('amdgpu-pro-libdrm=17.40.492261-1' 'amdgpu-pro=17.40.492261-1' 'libsystemd>=183')

	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./xserver-xorg-video-amdgpu-pro_1.3.99-492261_amd64.deb
	extract_deb "${srcdir}"/amdgpu-pro-17.40-492261/./xserver-xorg-video-modesetting-amdgpu-pro_1.19.0-492261_amd64.deb

	move_libdir "${pkgdir}/lib"

}

