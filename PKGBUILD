# Maintainer: Patrick Hechler <patrjprof@ph.anderemails.de>
pkgname=patrjprof
pkgver=1.1.0
pkgrel=1
pkgdesc="An Open source Java profiler written in Java"
arch=('any')
url="https://git.rwth-aachen.de/patrick_laszlo.hechler/patr-java-profiler"
license=('AGPL')
groups=()
depends=('java-runtime-headless>=8')
makedepends=('curl')
optdepends=()
provides=("patrjprof=${pkgver}")
conflicts=('patrjprof')
replaces=()
backup=()
options=()
install=
changelog=
noextract=()
source=("patr-java-profiler-agent-${pkgver}-jar-with-dependencies.jar::https://nexuspat.hechler.de/repository/maven-releases/de/hechler/patrick/profiler/patr-java-profiler-agent/${pkgver}/patr-java-profiler-agent-${pkgver}-jar-with-dependencies.jar"
        "patr-java-profiler-bootstrap-${pkgver}.jar::https://nexuspat.hechler.de/repository/maven-releases/de/hechler/patrick/profiler/patr-java-profiler-bootstrap/${pkgver}/patr-java-profiler-bootstrap-${pkgver}.jar"
        )
md5sums=('06c3fcba9e169ea05423e9814980eb54'
         '32688535a6ffce4eec273596f52cf241'
         )

package() {
  cd "$srcdir"

  VERSION=${pkgver}

  # copy original files
  mkdir -p "$pkgdir"/usr/lib/patrjprof
  cp -t "$pkgdir"/usr/lib/patrjprof \
    patr-java-profiler-agent-$VERSION-jar-with-dependencies.jar \
    patr-java-profiler-bootstrap-$VERSION.jar

  # create symlink of agent/bootstrap without version/version-with-deps appendix
  ln -sT patr-java-profiler-agent-$VERSION-jar-with-dependencies.jar "$pkgdir"/usr/lib/patrjprof/patr-java-profiler-agent-jar-with-dependencies.jar
  ln -sT patr-java-profiler-agent-$VERSION-jar-with-dependencies.jar "$pkgdir"/usr/lib/patrjprof/patr-java-profiler-agent.jar
  ln -sT patr-java-profiler-bootstrap-$VERSION.jar "$pkgdir"/usr/lib/patrjprof/patr-java-profiler-bootstrap.jar

  # create help script which starts the profiler, the other script is not available
  AGENT_JAR=/usr/lib/patrjprof/patr-java-profiler-agent-$VERSION-jar-with-dependencies.jar
  BOOTSTRAP_JAR=/usr/lib/patrjprof/patr-java-profiler-bootstrap-$VERSION.jar
  echo -n '#!/bin/sh
if test "$1" = "--help" ; then
  if test "$2" = "agent" ; then
    java "-javaagent:'$AGENT_JAR'=agent-help"
  elif test "$2" = "bootstrap" ; then
    java -cp '$BOOTSTRAP_JAR' de.hechler.patrick.profiler.Main bootstrap-help
  else
    echo -n "$0 help:
  Usage: $(basename $0)
             --help [agent|bootstrap]
             | --bootstrap [BOOTSTRAP_ARGS...]
             | [--agent <AGENT_OPTS>] <JVM_ARGS...>
    --help
      show this message
    --help agent
      show the java agents help message
    --help bootstrap
      show the boootstraps library help message
    --bootstrap [BOOTSTRAP_ARGS...]
      invoke the boostraps Main and pass all following arguments to it
      note that when this option is set the agent will not be attached to the JVM
    --agent <AGENT_OPTS>
      pass AGENT_OPTS to the java agent
      to pass multiple options to the agent use a \",\" to seperate them
    <JVM_ARGS...>
      pass these arguments to the JVM in the same order
      these arguments are passed behind the arguments generated by this script
"
  fi
  exit 1
elif test "$1" = "--bootstrap"; then
  exec java -cp '$BOOTSTRAP_JAR' \
    de.hechler.patrick.profiler.Main "${@:2}"
fi

AGENT_ARGS=""
ADD_ARGS_START=1
if test "$1" = "--agent"; then
  AGENT_ARGS="=$2"
  ADD_ARGS_START=3
fi

if test $ADD_ARGS_START -gt $# ; then
  echo -n "missing additional arguments!
you need to specify what you want to profile!

" >&2
  exec $0 --help >&2
fi

if test " $JAVA" = " "; then JAVA=java; fi

exec "$JAVA" \
  "-javaagent:'$AGENT_JAR'$AGENT_ARGS" \
  "-Xbootclasspath/a:'$BOOTSTRAP_JAR'" \
  "${@:$ADD_ARGS_START}"' > "$pkgdir"/usr/lib/patrjprof/patrjprof.sh
  chmod +x "$pkgdir"/usr/lib/patrjprof/patrjprof.sh

  # create symlink to the script
  mkdir -p "$pkgdir"/usr/bin
  ln -sT ../lib/patrjprof/patrjprof.sh "$pkgdir"/usr/bin/patrjprof
}
