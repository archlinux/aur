From 3e13bc965dbe309f8311509a67fc6990b1781f9c Mon Sep 17 00:00:00 2001
From: edgar <edgar [no] openmail.cc>
Date: Tue, 13 Jun 2023 00:03:13 +0200
Subject: [PATCH] local build for Python

---
 CMakeLists.txt        | 1 +
 python/CMakeLists.txt | 1 +
 python/setup.py       | 3 ++-
 3 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 3a7f2d94..8e8c01c5 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,5 +1,6 @@
 cmake_minimum_required(VERSION 3.19)
 
 project(BasixFull VERSION "0.6.0" LANGUAGES CXX)
+list(APPEND CMAKE_MODULE_PATH ${CMAKE_BINARY_DIR})
 add_subdirectory(cpp)
 add_subdirectory(python)
diff --git a/python/CMakeLists.txt b/python/CMakeLists.txt
index a9c33bde..df0b2c83 100644
--- a/python/CMakeLists.txt
+++ b/python/CMakeLists.txt
@@ -6,6 +6,7 @@ PROJECT(basix_pybind11 VERSION "0.6.0"  LANGUAGES CXX)
 set(CMAKE_CXX_STANDARD 20)
 set(CMAKE_CXX_STANDARD_REQUIRED ON)
 set(CMAKE_CXX_EXTENSIONS OFF)
+list(APPEND CMAKE_MODULE_PATH ${CMAKE_BINARY_DIR})
 
 # See https://gitlab.kitware.com/cmake/cmake/-/issues/16414
 if (TARGET basix)
diff --git a/python/setup.py b/python/setup.py
index 6cb52473..0b69b8b8 100644
--- a/python/setup.py
+++ b/python/setup.py
@@ -47,8 +47,10 @@ class CMakeBuild(build_ext):
             self.build_extension(ext)
 
     def build_extension(self, ext):
+        env = os.environ.copy()
         extdir = os.path.abspath(os.path.dirname(self.get_ext_fullpath(ext.name)))
         cmake_args = ['-DCMAKE_LIBRARY_OUTPUT_DIRECTORY=' + extdir,
+                      "-DCMAKE_PREFIX_PATH=" + env["CMAKE_PREFIX_PATH"],
                       '-DPython3_EXECUTABLE=' + sys.executable,
                       '-DPython3_LIBRARIES=' + sysconfig.get_config_var("LIBDEST"),
                       '-DPython3_INCLUDE_DIRS=' + sysconfig.get_config_var("INCLUDEPY")]
@@ -59,7 +61,6 @@ class CMakeBuild(build_ext):
         cmake_args += ['-DCMAKE_BUILD_TYPE=' + cfg]
         build_args += ['--', '-j3']
 
-        env = os.environ.copy()
         import pybind11
         env['pybind11_DIR'] = pybind11.get_cmake_dir()
         env['CXXFLAGS'] = '{} -DVERSION_INFO=\\"{}\\"'.format(env.get('CXXFLAGS', ''),
-- 
2.40.0

