#!/bin/bash

# Get the output of 'ddcutil detect'
ddcutil_output=$(ddcutil detect)

# Get the number of displays
num_displays=$(echo "${ddcutil_output}" | grep "Display" | wc -l)

force_config_rebuild=false

# Parse command line options
while getopts 'r|h' opt; do
    case "$opt" in
        r)
            force_config_rebuild=true
            ;;

        h)
            printf "Adjust monitor brightness using ddcutil\nOptions:\n\n  -r   rebuild config file\n  -h   this message\n\n"
    esac
done

# Load kernel module i2c-dev if it is not already loaded
if ! lsmod | grep -q i2c_dev; then
    sudo modprobe i2c-dev
fi

# Check if an input has been given
if [ -z "$1" ]; then
    echo "Enter a brightness value between 1 - 100."
    exit 1
fi 

# Check if brightness.conf exists
if [ -f /etc/brightness.conf ]; then
    exist=true
else
    exist=false
fi

# Check if the config file exists
if [[ "$force_config_rebuild" == "true" || "$exist" == false ]]; then
    # Remove old config file
    rm /etc/brightness.conf
    
    # Loop through each display
    for ((i=1;i<=num_displays;i++)); do

        # Extract I2C bus, DRM connector, manufacturer and model for this display
        i2c=$(echo "${ddcutil_output}" | awk -v i="$i" '/^Display.*'$i'/{f=1}f&&/I2C bus:/{sub(/\/dev\/i2c-/, "", $3); print $3; f=0}')
        drm=$(echo "${ddcutil_output}" | awk -v i="$i" '/^Display.*'$i'/{f=1}f&&/DRM connector:/{print $3; f=0}')
        manufacturer=$(echo "${ddcutil_output}" | awk -v i="$i" '/^Display.*'$i'/{f=1}f&&/Mfg id:/{print substr($0, index($0,$3)); f=0}')
        model=$(echo "${ddcutil_output}" | awk -v i="$i" '/^Display.*'$i'/{f=1}f&&/Model:/{print $2; f=0}')

        echo "Display $i:"
        echo "    I2C bus: $i2c"
        echo "    DRM connector: $drm"
        echo "    Manufacturer: $manufacturer"
        echo "    Model: $model"
        echo ""
    done

    while true; do
        echo "Enter the bus IDs of the monitors, separated by spaces:"
        read -ra monitor_bus_ids

        # Check if each number in monitor_bus_ids is in ddcutil_output
        condition=true
        for bus_id in "${monitor_bus_ids[@]}"; do
            if ! echo "${ddcutil_output}" | grep -q "   I2C bus:  /dev/i2c-${bus_id}"; then
                echo "bus id $bus_id doesn't exist."
                condition=false
                break
            fi
        done

        if $condition; then
            echo "monitor_bus_ids=(${monitor_bus_ids[@]})" >> /etc/brightness.conf
            break
        else
            echo "Please try again."
            echo ""
        fi
    done
fi

# Read monitor information from the config file
source /etc/brightness.conf

# Set the brightness for each monitor concurrently
printf '%s\n' "${monitor_bus_ids[@]}" | parallel --jobs "$num_displays" "ddcutil setvcp 10 '$1' --bus {} --noverify &"