#!/usr/bin/env bash

VDF_VERSION='@PACKAGE_VERSION@'

VDF_INSTALL_DIR="/usr/share/videoduplicatefinder"
VDF_USER_DIR="/home/${USER}/.local/share/videoduplicatefinder"
VDF_VERSION_FILE="${VDF_USER_DIR}/VERSION"
VDF_INSTALLED_FILES_LIST="${VDF_USER_DIR}/INSTALLED"

set -e

# Create user directory
if [ ! -d "${VDF_USER_DIR}" ]; then
    mkdir -p "${VDF_USER_DIR}"
fi

# Create version file
if [ ! -f "${VDF_VERSION_FILE}" ]; then
    echo 0 > "${VDF_VERSION_FILE}"
fi

cd "${VDF_USER_DIR}"

# Get installed version
while read VDF_VER_LINE_; do
    VDF_INSTALLED_VERSION="${VDF_VER_LINE_}"
done < "${VDF_VERSION_FILE}"

# Check if file need update
if [ "${VDF_INSTALLED_VERSION}" != "${VDF_VERSION}" ] || [ "${VDF_INSTALLED_VERSION}" == 0 ]; then
    # Delete old files
    if [ -f "${VDF_INSTALLED_FILES_LIST}" ]; then
        while read VDF_OLD_FILE; do
            rm -rf "${VDF_USER_DIR}/${VDF_OLD_FILE}"
        done < "${VDF_INSTALLED_FILES_LIST}"
    fi

    rm -f "${VDF_USER_DIR}/log.txt"

    # Copy files
    cp "${VDF_INSTALL_DIR}"/* "${VDF_USER_DIR}"

    # Make new installed files list
    ls "${VDF_INSTALL_DIR}" > "${VDF_INSTALLED_FILES_LIST}"

    # Make new version file
    echo ${VDF_VERSION} > "${VDF_VERSION_FILE}"
fi

echo "Starting Video Duplicate Finder for user ${USER}..."
"${VDF_USER_DIR}/VDF.GUI" "${args[@]}"
