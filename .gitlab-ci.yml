image: manjarolinux/base:latest

variables:
  GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

before_script:
  - pacman -Syu --noconfirm sed jq binutils gtk3 libxss libindicator-gtk2 nss dbus-glib libdbusmenu-gtk2 git
  - useradd -m builduser
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh


stages:
  - find_release
  - test
  - release

find_release_job:
  stage: find_release
  script: 
    - su -c "cd ${CI_PROJECT_DIR} && ./find_release.sh" - builduser
  artifacts:
    paths:
      - PKGBUILD
      - .SRCINFO
  only:
    - schedules

test_job:
  stage: test
  script: 
    - su -c "cd ${CI_PROJECT_DIR} && ./test" - builduser
  dependencies:
    - find_release_job
  only:
    - schedules

release_job:
  stage: release
  script: ./release
  dependencies:
    - find_release_job
  only:
    - schedules
