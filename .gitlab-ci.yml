image: node:alpine

workflow:
  name: 'Pipeline for branch: $CI_COMMIT_BRANCH'
  rules:
    - changes:
      - ${CI_CONFIG_PATH}

build:
  stage: build
  script:
    - npm install
    - |
      sed -i.old $(for arg in `node get_latest`; do
        key=${arg%%=*}
        value=${arg#*=}

        echo "-e s|$key=.*|$key=$value|g"
      done) PKGBUILD
    - diff PKGBUILD.old PKGBUILD && exit 1 || exit_code=$?
    - if [ $exit_code -ne 1 ]; exit $exit_code; fi
  artifacts:
    paths:
      - "PKGBUILD"
  cache:
    key: node_modules-cache
    paths:
      - node_modules/
  allow_failure: true

deploy:
  stage: deploy
  image: archlinux:base-devel
  script:
    - updpkgsums
    - makepkg --printsrcinfo > .SRCINFO
  needs:
    - build
