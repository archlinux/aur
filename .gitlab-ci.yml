image: manjarolinux/base:latest

before_script:
  - pacman -Syu --noconfirm sed jq binutils
  - useradd -m builduser
  - passwd -d builduser
  - printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers

stages:
  - find_release
  - test
  - release

find_release_job:
  stage: find_release
  script: 
    -su -c "cd ${CI_PROJECT_DIR} && ./find_release.sh" - builduser
  artifacts:
    paths:
      - PKGBUILD
      - .SRCINFO
  only:
    - schedules

test_job:
  stage: test
  script: 
    - -su -c "cd ${CI_PROJECT_DIR} && ./test" - builduser
  dependencies:
    - find_release_job
  only:
    - schedules

release_job:
  stage: release
  script: ./release
  dependencies:
    - find_release_job
  only:
    - schedules
