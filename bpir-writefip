#!/bin/bash

rootdev=$(lsblk -pilno pkname,type,mountpoint | grep -G 'part /$' |  head -n1 | cut -d " " -f1)
partlabelroot=$(lsblk -plno partlabel $rootdev | grep -G '\-root$' )
[ ! -n "$partlabelroot" ] && exit
target=${partlabelroot%%-*}

[ ! -d "/boot/bootcfg/" ] && exit
[ ! -d "/boot/dtbos/" ] && exit
fipdev=$(cat   /boot/bootcfg/device)
linux=$(cat    /boot/bootcfg/linux)
cmdline=$(cat  /boot/bootcfg/cmdline)
initrd=$(cat   /boot/bootcfg/initrd)
dtb=$(cat      /boot/bootcfg/dtb)

if [[ $@ =~ "--atf" ]]; then
  atfdev="/dev/disk/by-partlabel/${target}-${fipdev}-atf"
  if [ -L $atfdev ]; then
    if [ -f "/boot/${target}-atf-${fipdev}-header.bin" ]; then
      headerdev="/dev/"$(lsblk -no pkname ${atfdev})
      echo Writing ${target}-atf-${fipdev}-header.bin to $headerdev
      dd of="${headerdev}" if=/boot/${target}-atf-${fipdev}-header.bin
    fi
    echo -e "Target = ${target}, ATF device = ${fipdev}\nZeroing: $atfdev"
    dd bs=64k of="${atfdev}" if=/dev/zero 2>/dev/null
    echo Writing ${target}-atf-${fipdev}-atf.bin to $atfdev
    dd bs=64k of="${atfdev}" if=/boot/${target}-atf-${fipdev}-atf.bin
  fi
fi

tmp="/tmp/bpir64-atf-git"
mkdir -p $tmp
cp -vf "/boot/dtbs/${dtb}.dtb" "/boot/dtbs/${dtb}-fixed.dtb"
for bp in /boot/dtbos/*.dts; do
  echo "Creating .dtbo from $(basename $bp)"
  dtc -q -I dts -O dtb -o ${bp/".dts"/".dtbo"} $bp
  cat $bp | grep "//fdtput" | while read -r line ; do
    echo fdtput "/boot/dtbs/${dtb}-fixed.dtb" ${line/"//fdtput"/""}
         fdtput "/boot/dtbs/${dtb}-fixed.dtb" ${line/"//fdtput"/""}
  done
done
fdtoverlay -vi "/boot/dtbs/${dtb}-fixed.dtb" -o "/boot/atf-direct.dtb" \
                /boot/dtbos/*.dtbo
origargs=$(fdtget -ts "/boot/atf-direct.dtb" "/chosen" "bootargs")
bootargs="root=PARTLABEL=${target}-${fipdev}-root $origargs $cmdline"
echo BOOTARGS = "$bootargs"
fdtput -ts "/boot/atf-direct.dtb" "/chosen" "bootargs" "$bootargs"
fdtput -ts "/boot/atf-direct.dtb" "/memory" "device_type" "memory"
if [ -f "$initrd" ];then
  ins="0x48000000"
  ine="0x$(printf '%x\n' $(( $ins + $(du -b $initrd | cut -f1) )))"
  fdtput -tx "/boot/atf-direct.dtb" "/chosen" "linux,initrd-end" "$ine"
  fdtput -tx "/boot/atf-direct.dtb" "/chosen" "linux,initrd-start" "$ins"
  initrdfile="$initrd"
else
  echo -n "" > "$tmp/initrd"
  initrdfile="$tmp/initrd"
fi

if [ -f "/boot/${target}-atf-${fipdev}-bl31.bin" ]; then
  bl31="--soc-fw /boot/${target}-atf-${fipdev}-bl31.bin"
else
  bl31=""
fi

fiptool --verbose create $tmp/fip.bin \
                 $bl31 \
             --nt-fw $linux \
       --nt-fw-config "/boot/atf-direct.dtb" \
      --tos-fw-extra2 $initrdfile
fiptool info $tmp/fip.bin
fipdev="/dev/disk/by-partlabel/${target}-${fipdev}-fip"
[ ! -L $fipdev ] && exit 0
echo Writing FIP to: $fipdev
dd bs=1M of=$fipdev if=/dev/zero 2>/dev/null
dd bs=1M of=$fipdev if=$tmp/fip.bin

exit 0
