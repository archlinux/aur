From 25ca66caeee2bc7fa932a5f4d934406a8d8fdc59 Mon Sep 17 00:00:00 2001
From: KokaKiwi <kokakiwi+git@kokakiwi.net>
Date: Mon, 31 Jan 2022 20:20:40 +0100
Subject: [PATCH 3/4] archlinux-compat: Remove unused mbedTLS code from libcurl
 usage

---
 lib/libimhex/source/helpers/net.cpp | 28 +---------------------------
 1 file changed, 1 insertion(+), 27 deletions(-)

diff --git a/lib/libimhex/source/helpers/net.cpp b/lib/libimhex/source/helpers/net.cpp
index 5793b57f..f89caca4 100644
--- a/lib/libimhex/source/helpers/net.cpp
+++ b/lib/libimhex/source/helpers/net.cpp
@@ -9,8 +9,6 @@
 #include <filesystem>
 #include <cstdio>
 
-#include <mbedtls/ssl.h>
-
 #include <curl/curl.h>
 #include <nlohmann/json.hpp>
 
@@ -46,23 +44,6 @@ namespace hex {
         return fwrite(contents, size, nmemb, file);
     }
 
-    [[maybe_unused]]
-    static CURLcode sslCtxFunction(CURL *ctx, void *sslctx, void *userData) {
-        hex::unused(ctx, userData);
-
-        auto *cfg = static_cast<mbedtls_ssl_config *>(sslctx);
-
-        static mbedtls_x509_crt crt;
-        mbedtls_x509_crt_init(&crt);
-
-        auto cacert = romfs::get("cacert.pem").string();
-        mbedtls_x509_crt_parse(&crt, reinterpret_cast<const u8 *>(cacert.data()), cacert.size());
-
-        mbedtls_ssl_conf_ca_chain(cfg, &crt, nullptr);
-
-        return CURLE_OK;
-    }
-
     int progressCallback(void *contents, curl_off_t dlTotal, curl_off_t dlNow, curl_off_t ulTotal, curl_off_t ulNow) {
         auto &net = *static_cast<Net *>(contents);
 
@@ -109,13 +90,6 @@ namespace hex {
         curl_easy_setopt(this->m_ctx, CURLOPT_NOSIGNAL, 1L);
         curl_easy_setopt(this->m_ctx, CURLOPT_NOPROGRESS, 0L);
 
-#if defined(OS_WINDOWS)
-        curl_easy_setopt(this->m_ctx, CURLOPT_CAINFO, nullptr);
-        curl_easy_setopt(this->m_ctx, CURLOPT_CAPATH, nullptr);
-        curl_easy_setopt(this->m_ctx, CURLOPT_SSLCERTTYPE, "PEM");
-        curl_easy_setopt(this->m_ctx, CURLOPT_SSL_CTX_FUNCTION, sslCtxFunction);
-#endif
-
         curl_easy_setopt(this->m_ctx, CURLOPT_PROXY, Net::s_proxyUrl.c_str());
     }
 
@@ -264,4 +238,4 @@ namespace hex {
         Net::s_proxyUrl = url;
     }
 
-}
\ No newline at end of file
+}
-- 
2.37.1

